<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="TaskFlow - Your personal productivity companion">
  <meta name="author" content="TaskFlow">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .task-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .add-task-form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .task-completed {
      opacity: 0.6;
    }
    .task-completed .card-text {
      text-decoration: line-through;
      color: #6c757d;
    }
    .task-checkbox {
      transform: scale(1.2);
      margin-right: 10px;
    }
    .task-actions {
      opacity: 0;
      transition: opacity 0.2s;
    }
    .task-card:hover .task-actions {
      opacity: 1;
    }
    .edit-form {
      display: none;
    }
    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    .priority-indicator {
      width: 4px;
      height: 100%;
      position: absolute;
      left: 0;
      top: 0;
      border-radius: 8px 0 0 8px;
    }
    .priority-high { background-color: #dc3545; }
    .priority-medium { background-color: #ffc107; }
    .priority-low { background-color: #198754; }
    .priority-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    .task-card {
      position: relative;
    }
    .due-date-indicator {
      font-size: 0.75rem;
    }
    .due-today {
      color: #fd7e14;
      font-weight: bold;
    }
    .due-overdue {
      color: #dc3545;
      font-weight: bold;
    }
    .due-upcoming {
      color: #6f42c1;
    }
    
    /* Kanban Board Styles */
    .kanban-board {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding: 20px 0;
    }
    .kanban-column {
      flex: 1;
      min-width: 300px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
    }
    .kanban-header {
      text-align: center;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      font-weight: bold;
    }
    .kanban-todo { background-color: #e3f2fd; }
    .kanban-progress { background-color: #fff3e0; }
    .kanban-done { background-color: #e8f5e8; }
    
    .kanban-task {
      background: white;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: move;
      transition: all 0.2s;
    }
    .kanban-task:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .kanban-task.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    .kanban-tasks.drag-over {
      background-color: #e3f2fd;
      border: 2px dashed #2196f3;
      border-radius: 8px;
      min-height: 200px;
    }
    .kanban-tasks {
      min-height: 150px;
      padding: 10px;
    }
    .nav-link.active {
      background-color: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
    
    /* Search & Filter Styling */
    .search-filter-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #dee2e6;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .filter-tag {
      display: inline-block;
      background-color: #007bff;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85rem;
      margin: 2px;
    }
    
    .filter-tag .btn-close {
      font-size: 0.7rem;
      margin-left: 6px;
    }
    
    .task-hidden {
      display: none !important;
    }
    
    .no-results {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
    
    #searchInput:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    /* Dark Mode Styles */
    [data-theme="dark"] {
      background-color: #121212;
      color: #e0e0e0;
    }
    
    [data-theme="dark"] .navbar {
      background-color: #1f1f1f !important;
    }
    
    [data-theme="dark"] .container {
      background-color: #121212;
    }
    
    [data-theme="dark"] .add-task-form {
      background: linear-gradient(135deg, #2d2d2d, #404040);
      border: 1px solid #555;
    }
    
    [data-theme="dark"] .search-filter-section {
      background: linear-gradient(135deg, #2d2d2d, #404040);
      border: 1px solid #555;
    }
    
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-select {
      background-color: #3d3d3d;
      border-color: #555;
      color: #e0e0e0;
    }
    
    [data-theme="dark"] .form-control:focus,
    [data-theme="dark"] .form-select:focus {
      background-color: #3d3d3d;
      border-color: #007bff;
      color: #e0e0e0;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    [data-theme="dark"] .btn-primary {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    
    [data-theme="dark"] .btn-primary:hover {
      background-color: #004085;
      border-color: #004085;
    }
    
    [data-theme="dark"] .btn-outline-secondary {
      color: #adb5bd;
      border-color: #6c757d;
    }
    
    [data-theme="dark"] .btn-outline-secondary:hover {
      color: #212529;
      background-color: #adb5bd;
      border-color: #adb5bd;
    }
    
    [data-theme="dark"] .btn-outline-danger {
      color: #dc3545;
      border-color: #dc3545;
    }
    
    [data-theme="dark"] .btn-outline-danger:hover {
      color: #fff;
      background-color: #dc3545;
      border-color: #dc3545;
    }
    
    /* Dark Mode Cards */
    [data-theme="dark"] .card {
      background-color: #2d2d2d;
      border-color: #555;
    }
    
    [data-theme="dark"] .task-card {
      background-color: #2d2d2d;
      border-color: #555;
    }
    
    [data-theme="dark"] .task-card:hover {
      box-shadow: 0 4px 8px rgba(255,255,255,0.1);
    }
    
    /* Dark Mode Kanban */
    [data-theme="dark"] .kanban-board {
      background-color: #121212;
    }
    
    [data-theme="dark"] .kanban-column {
      background-color: #1e1e1e;
      border: 1px solid #444;
    }
    
    [data-theme="dark"] .kanban-header {
      background-color: #2d2d2d;
      color: #e0e0e0;
    }
    
    [data-theme="dark"] .kanban-task {
      background-color: #2d2d2d;
      border: 1px solid #555;
      color: #e0e0e0;
    }
    
    [data-theme="dark"] .kanban-task:hover {
      box-shadow: 0 4px 8px rgba(255,255,255,0.1);
    }
    
    [data-theme="dark"] .kanban-tasks.drag-over {
      background-color: #1a4971;
      border: 2px dashed #5bc0de;
    }
    
    /* Dark Mode Modal */
    [data-theme="dark"] .modal-content {
      background-color: #2d2d2d;
      color: #e0e0e0;
      border: 1px solid #555;
    }
    
    [data-theme="dark"] .modal-header {
      border-bottom-color: #555;
    }
    
    [data-theme="dark"] .modal-footer {
      border-top-color: #555;
    }
    
    [data-theme="dark"] .btn-close {
      filter: invert(1);
    }
    
    /* Dark Mode Text Colors */
    [data-theme="dark"] .text-muted {
      color: #adb5bd !important;
    }
    
    [data-theme="dark"] .due-date-indicator {
      color: #adb5bd;
    }
    
    /* Dark Mode Badges */
    [data-theme="dark"] .badge.bg-primary {
      background-color: #0d6efd !important;
    }
    
    [data-theme="dark"] .badge.bg-success {
      background-color: #198754 !important;
    }
    
    [data-theme="dark"] .badge.bg-warning {
      background-color: #ffc107 !important;
      color: #212529 !important;
    }
    
    [data-theme="dark"] .badge.bg-danger {
      background-color: #dc3545 !important;
    }
    
    /* Theme Toggle Button */
    .theme-toggle {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1050;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    
    .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    [data-theme="dark"] .theme-toggle {
      background-color: #ffc107;
      color: #212529;
    }
    
    [data-theme="light"] .theme-toggle {
      background-color: #6f42c1;
      color: white;
    }
    
    /* Mobile Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .add-task-form {
        padding: 15px;
        margin-bottom: 20px;
      }
      
      .add-task-form .row {
        flex-direction: column;
      }
      
      .add-task-form .col-md-6,
      .add-task-form .col-md-2 {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .search-filter-section {
        padding: 15px;
      }
      
      .search-filter-section .row {
        flex-direction: column;
      }
      
      .search-filter-section .col-md-4,
      .search-filter-section .col-md-2 {
        width: 100%;
        margin-bottom: 10px;
      }
      
      /* Mobile Kanban */
      .kanban-board {
        flex-direction: column;
        gap: 15px;
      }
      
      .kanban-column {
        width: 100% !important;
        min-height: 200px;
      }
      
      .kanban-task {
        margin-bottom: 10px;
        padding: 12px;
      }
      
      .kanban-header {
        padding: 12px;
        font-size: 1rem;
      }
      
      /* Mobile List View */
      .task-card {
        margin-bottom: 15px;
      }
      
      .card-body {
        padding: 15px;
      }
      
      /* Mobile Theme Toggle */
      .theme-toggle {
        top: 70px;
        right: 15px;
        width: 45px;
        height: 45px;
        font-size: 1rem;
      }
      
      /* Mobile Navigation */
      .navbar-brand {
        font-size: 1.1rem;
      }
      
      .nav-link {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
      
      /* Mobile Modal */
      .modal-dialog {
        margin: 10px;
      }
      
      .modal-content {
        border-radius: 8px;
      }
      
      /* Mobile Forms */
      .form-control-lg {
        padding: 10px 12px;
        font-size: 1rem;
      }
      
      .form-select-lg {
        padding: 10px 12px;
        font-size: 1rem;
      }
      
      .btn-lg {
        padding: 10px 16px;
        font-size: 1rem;
      }
      
      /* Mobile Priority Indicators */
      .priority-indicator {
        width: 4px;
        height: 100%;
      }
      
      .kanban-task .priority-indicator {
        width: 3px;
      }
    }
    
    /* Tablet Responsive Design */
    @media (min-width: 769px) and (max-width: 1024px) {
      .kanban-column {
        width: 32%;
      }
      
      .container {
        max-width: 95%;
      }
      
      .search-filter-section .col-md-4 {
        flex: 0 0 40%;
      }
      
      .search-filter-section .col-md-2 {
        flex: 0 0 20%;
      }
    }
    
    /* Large Screen Optimizations */
    @media (min-width: 1200px) {
      .kanban-column {
        width: 31%;
      }
      
      .container {
        max-width: 1400px;
      }
      
      .kanban-task {
        margin-bottom: 12px;
      }
    }
    
    /* Touch Device Optimizations */
    @media (hover: none) and (pointer: coarse) {
      .kanban-task {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .btn {
        padding: 12px 20px;
        font-size: 1rem;
      }
      
      .form-control,
      .form-select {
        padding: 12px;
        font-size: 1rem;
      }
      
      .kanban-task:hover {
        transform: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .task-card:hover {
        transform: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
    }
  </style>
</head>
<body>
<!-- Theme Toggle Button -->
<button class="btn theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
  <i class="bi bi-moon-fill" id="themeIcon"></i>
</button>

<%- include('./header'); %>
<%- include('./error_messages'); %>
<% if(isAuth) { %>
<div class="container mt-4">
  <!-- Add Task Form -->
  <div class="add-task-form">
    <h4 class="mb-3">
      <i class="bi bi-plus-circle"></i> Add New Task
    </h4>
    <form action="/" method="post" onsubmit="addViewParam(this)">
      <div class="row g-2">
        <div class="col-md-6">
          <input 
            required 
            type="text" 
            name="add" 
            class="form-control form-control-lg" 
            placeholder="What needs to be done?"
          />
        </div>
        <div class="col-md-2">
          <select name="priority" class="form-select form-select-lg">
            <option value="low">üü¢ Low</option>
            <option value="medium" selected>üü° Medium</option>
            <option value="high">üî¥ High</option>
          </select>
        </div>
        <div class="col-md-2">
          <input 
            type="date" 
            name="due_date" 
            class="form-control form-control-lg"
            min="<%= new Date().toISOString().split('T')[0] %>"
          />
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-plus"></i> Add
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Search & Filter Controls -->
  <div class="search-filter-section mb-4">
    <div class="row g-3">
      <!-- Search Bar -->
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input 
            type="text" 
            id="searchInput" 
            class="form-control" 
            placeholder="Search tasks..."
            autocomplete="off"
          />
          <button class="btn btn-outline-secondary" type="button" id="clearSearch" title="Clear search">
            <i class="bi bi-x"></i>
          </button>
        </div>
      </div>

      <!-- Priority Filter -->
      <div class="col-md-2">
        <select id="priorityFilter" class="form-select">
          <option value="">All Priorities</option>
          <option value="high">üî¥ High</option>
          <option value="medium">üü° Medium</option>
          <option value="low">üü¢ Low</option>
        </select>
      </div>

      <!-- Status Filter -->
      <div class="col-md-2">
        <select id="statusFilter" class="form-select">
          <option value="">All Status</option>
          <option value="todo">üìã To Do</option>
          <option value="in_progress">‚ö° In Progress</option>
          <option value="done">‚úÖ Done</option>
        </select>
      </div>

      <!-- Due Date Filter -->
      <div class="col-md-2">
        <select id="dueDateFilter" class="form-select">
          <option value="">All Due Dates</option>
          <option value="overdue">üî¥ Overdue</option>
          <option value="today">üìÖ Due Today</option>
          <option value="tomorrow">‚è∞ Due Tomorrow</option>
          <option value="this_week">üìÜ This Week</option>
          <option value="no_date">üìù No Due Date</option>
        </select>
      </div>

      <!-- Clear All Filters -->
      <div class="col-md-2">
        <button class="btn btn-outline-danger w-100" id="clearFilters" title="Clear all filters">
          <i class="bi bi-funnel"></i> Clear Filters
        </button>
      </div>
    </div>

    <!-- Active Filters Display -->
    <div id="activeFilters" class="mt-2 d-none">
      <small class="text-muted">Active filters:</small>
      <div id="filterTags" class="d-inline"></div>
    </div>
  </div>

  <!-- Tasks Display -->
  <% if (view === 'kanban') { %>
    <!-- Kanban Board View -->
    <div class="kanban-board">
      <!-- To Do Column -->
      <div class="kanban-column" data-status="todo">
        <div class="kanban-header kanban-todo">
          <i class="bi bi-list-task"></i> To Do
          <span class="badge bg-primary ms-2">
            <%= todos.filter(t => t.status === 'todo').length %>
          </span>
        </div>
        <div class="kanban-tasks" id="todo-tasks">
          <% todos.filter(t => t.status === 'todo').forEach(function(todo) { %>
            <%- include('partials/kanban-task', {todo: todo}) %>
          <% }) %>
        </div>
      </div>

      <!-- In Progress Column -->
      <div class="kanban-column" data-status="in_progress">
        <div class="kanban-header kanban-progress">
          <i class="bi bi-arrow-clockwise"></i> In Progress
          <span class="badge bg-warning ms-2">
            <%= todos.filter(t => t.status === 'in_progress').length %>
          </span>
        </div>
        <div class="kanban-tasks" id="in_progress-tasks">
          <% todos.filter(t => t.status === 'in_progress').forEach(function(todo) { %>
            <%- include('partials/kanban-task', {todo: todo}) %>
          <% }) %>
        </div>
      </div>

      <!-- Done Column -->
      <div class="kanban-column" data-status="done">
        <div class="kanban-header kanban-done">
          <i class="bi bi-check-circle"></i> Done
          <span class="badge bg-success ms-2">
            <%= todos.filter(t => t.status === 'done').length %>
          </span>
        </div>
        <div class="kanban-tasks" id="done-tasks">
          <% todos.filter(t => t.status === 'done').forEach(function(todo) { %>
            <%- include('partials/kanban-task', {todo: todo}) %>
          <% }) %>
        </div>
      </div>
    </div>
  <% } else { %>
    <!-- List View -->
    <div class="row">
      <div class="col-12">
        <h4 class="mb-3">
          <i class="bi bi-list-task"></i> Your Tasks
          <span class="badge bg-primary ms-2">
            <%= todos.filter(t => !t.completed).length %> active
          </span>
          <% if (todos.filter(t => t.completed).length > 0) { %>
            <span class="badge bg-success ms-1">
              <%= todos.filter(t => t.completed).length %> completed
            </span>
          <% } %>
        </h4>
        
        <% if(todos.length === 0) { %>
          <div class="text-center py-5">
            <i class="bi bi-clipboard-check" style="font-size: 4rem; color: #dee2e6;"></i>
            <p class="text-muted mt-3">No tasks yet! Add your first task above.</p>
          </div>
        <% } else { %>
          <div class="row">
            <% for(let todo of todos){ %>
              <%- include('partials/list-task', {todo: todo}) %>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  <% } %>
</div>
<% } else { %>
  <div class="container text-center mt-5">
    <h1 class="display-4 mb-4">Welcome to TaskFlow</h1>
    <p class="lead mb-4">Your personal productivity companion</p>
    <a class="btn btn-primary btn-lg" href="/signup" role="button">
      <i class="bi bi-person-plus"></i> Get Started
    </a>
  </div>
<% } %>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editTaskForm" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editTaskContent" class="form-label">Task Description</label>
            <input type="text" class="form-control" id="editTaskContent" name="content" required>
          </div>
          <div class="mb-3">
            <label for="editTaskPriority" class="form-label">Priority</label>
            <select class="form-select" id="editTaskPriority" name="priority" required>
              <option value="low">üü¢ Low</option>
              <option value="medium">üü° Medium</option>
              <option value="high">üî¥ High</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editTaskDueDate" class="form-label">Due Date</label>
            <input type="date" class="form-control" id="editTaskDueDate" name="due_date">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function editTask(taskId) {
  // Hide display mode
  document.querySelector('.task-display-' + taskId).style.display = 'none';
  // Show edit mode
  document.querySelector('.task-edit-' + taskId).style.display = 'block';
  // Focus on the input
  document.querySelector('.task-edit-' + taskId + ' input').focus();
}

function cancelEdit(taskId) {
  // Show display mode
  document.querySelector('.task-display-' + taskId).style.display = 'block';
  // Hide edit mode
  document.querySelector('.task-edit-' + taskId).style.display = 'none';
}

function formatDueDate(dueDate) {
  if (!dueDate) return '';
  
  const today = new Date();
  const due = new Date(dueDate);
  const diffTime = due.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) {
    return { text: `Overdue by ${Math.abs(diffDays)} day(s)`, class: 'due-overdue' };
  } else if (diffDays === 0) {
    return { text: 'Due today', class: 'due-today' };
  } else if (diffDays === 1) {
    return { text: 'Due tomorrow', class: 'due-upcoming' };
  } else if (diffDays <= 7) {
    return { text: `Due in ${diffDays} days`, class: 'due-upcoming' };
  } else {
    return { text: `Due ${due.toLocaleDateString()}`, class: '' };
  }
}

// Kanban Board Functionality
function initKanbanBoard() {
  console.log('Initializing Kanban board...');
  const kanbanTasks = document.querySelectorAll('.kanban-task');
  const kanbanColumns = document.querySelectorAll('.kanban-tasks');
  
  console.log('Found tasks:', kanbanTasks.length);
  console.log('Found columns:', kanbanColumns.length);
  
  // Test if tasks are properly found
  kanbanTasks.forEach((task, index) => {
    console.log(`Task ${index}:`, task.dataset.taskId, 'draggable:', task.draggable);
  });
  
  // Add drag events to tasks
  kanbanTasks.forEach((task, index) => {
    console.log(`Adding drag events to task ${index}:`, task.dataset.taskId);
    
    // Ensure draggable is set
    task.draggable = true;
    
    task.addEventListener('dragstart', handleDragStart);
    task.addEventListener('dragend', handleDragEnd);
    
    // Add test click event to verify event handling works
    task.addEventListener('click', function(e) {
      if (!e.target.closest('button')) {
        console.log('Task clicked:', this.dataset.taskId);
      }
    });
  });
  
  // Add drop events to columns
  kanbanColumns.forEach((column, index) => {
    console.log(`Adding drop events to column ${index}:`, column.id);
    column.addEventListener('dragover', handleDragOver);
    column.addEventListener('drop', handleDrop);
    column.addEventListener('dragenter', handleDragEnter);
    column.addEventListener('dragleave', handleDragLeave);
  });
  
  // Also add events to the column containers for better drop zone coverage
  const columnContainers = document.querySelectorAll('.kanban-column');
  columnContainers.forEach((container, index) => {
    console.log(`Adding additional drop events to container ${index}:`, container.dataset.status);
    container.addEventListener('dragover', handleDragOver);
    container.addEventListener('dragenter', function(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      const tasksArea = this.querySelector('.kanban-tasks');
      if (tasksArea) {
        console.log('Container drag enter:', tasksArea.id);
        tasksArea.classList.add('drag-over');
      }
    });
    container.addEventListener('drop', function(e) {
      const tasksArea = this.querySelector('.kanban-tasks');
      if (tasksArea) {
        handleDrop.call(tasksArea, e);
      }
    });
  });
}

let draggedTask = null;

function handleDragStart(e) {
  console.log('Drag start:', this.dataset.taskId);
  draggedTask = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.outerHTML);
}

function handleDragEnd(e) {
  console.log('Drag end');
  this.classList.remove('dragging');
  // Don't reset draggedTask here - we need it in handleDrop
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDragEnter(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  console.log('Drag enter:', this.id);
  this.classList.add('drag-over');
  return false;
}

function handleDragLeave(e) {
  // Only remove drag-over if we're actually leaving this element
  if (!this.contains(e.relatedTarget)) {
    console.log('Drag leave:', this.id);
    this.classList.remove('drag-over');
  }
}

function handleDrop(e) {
  console.log('Drop event triggered on:', this.id);
  
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  if (e.preventDefault) {
    e.preventDefault();
  }
  
  this.classList.remove('drag-over');
  
  if (!draggedTask) {
    console.log('No dragged task found');
    return false;
  }
  
  const taskId = draggedTask.dataset.taskId;
  const newStatus = this.parentElement.dataset.status;
  const currentColumn = draggedTask.closest('.kanban-tasks');
  const oldStatus = currentColumn ? currentColumn.parentElement.dataset.status : null;
  
  console.log('Drop details:', { taskId, newStatus, oldStatus });
  
  if (newStatus !== oldStatus) {
    // Cross-column move (status change)
    console.log('Status changed, moving task...');
    this.appendChild(draggedTask);
    updateTaskStatus(taskId, newStatus);
  } else {
    // Intra-column reorder (same status, different position)
    console.log('Reordering within same column...');
    
    // Calculate new position based on drop location
    const dropY = e.clientY;
    const tasks = Array.from(this.children);
    let newPosition = tasks.length;
    
    // Find where to insert based on mouse position
    for (let i = 0; i < tasks.length; i++) {
      const task = tasks[i];
      if (task === draggedTask) continue;
      
      const rect = task.getBoundingClientRect();
      const taskMiddle = rect.top + rect.height / 2;
      
      if (dropY < taskMiddle) {
        newPosition = i;
        break;
      }
    }
    
    // Get current position of dragged task
    const currentPosition = tasks.indexOf(draggedTask);
    
    // Only reorder if position actually changed
    if (newPosition !== currentPosition && newPosition !== currentPosition + 1) {
      // Adjust position if moving down (account for removed element)
      if (newPosition > currentPosition) {
        newPosition--;
      }
      
      console.log('Reordering from position', currentPosition, 'to', newPosition);
      
      // Move the element visually
      if (newPosition >= tasks.length - 1) {
        this.appendChild(draggedTask);
      } else {
        this.insertBefore(draggedTask, this.children[newPosition]);
      }
      
      // Update on server
      updateTaskOrder(taskId, newPosition, newStatus);
    } else {
      console.log('Position unchanged, no reorder needed');
    }
  }
  
  // Reset dragged task
  draggedTask = null;
  
  return false;
}

function updateTaskStatus(taskId, newStatus) {
  console.log('Updating task status:', { taskId, newStatus });
  
  fetch(`/status/${taskId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({ status: newStatus }),
  })
  .then(response => {
    console.log('Response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Task status updated successfully:', data);
    // Update column counters
    updateColumnCounters();
  })
  .catch(error => {
    console.error('Error updating task status:', error);
    alert('Failed to update task status. Please try again.');
    // Reload page on error to ensure consistency
    window.location.reload();
  });
}

function updateTaskOrder(taskId, newPosition, status) {
  console.log('Updating task order:', { taskId, newPosition, status });
  
  fetch('/reorder', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({ 
      taskId: taskId, 
      newPosition: newPosition, 
      status: status 
    }),
  })
  .then(response => {
    console.log('Reorder response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Task order updated successfully:', data);
  })
  .catch(error => {
    console.error('Error updating task order:', error);
    alert('Failed to reorder task. Please try again.');
    // Reload page on error to ensure consistency
    window.location.reload();
  });
}

function updateColumnCounters() {
  const todoCount = document.querySelectorAll('#todo-tasks .kanban-task').length;
  const progressCount = document.querySelectorAll('#in_progress-tasks .kanban-task').length;
  const doneCount = document.querySelectorAll('#done-tasks .kanban-task').length;
  
  document.querySelector('.kanban-todo .badge').textContent = todoCount;
  document.querySelector('.kanban-progress .badge').textContent = progressCount;
  document.querySelector('.kanban-done .badge').textContent = doneCount;
}

function deleteTask(taskId) {
  if (confirm('Are you sure you want to delete this task?')) {
    const currentView = new URLSearchParams(window.location.search).get('view');
    const form = document.createElement('form');
    form.method = 'POST';
    
    // Include view in the action URL if present
    if (currentView) {
      form.action = `/delete/${taskId}?view=${currentView}`;
    } else {
      form.action = `/delete/${taskId}`;
    }
    
    document.body.appendChild(form);
    form.submit();
  }
}

// Function to add current view parameter to forms
function addViewParam(form) {
  const currentView = new URLSearchParams(window.location.search).get('view');
  if (currentView) {
    const currentAction = form.action;
    const separator = currentAction.includes('?') ? '&' : '?';
    form.action = currentAction + separator + 'view=' + currentView;
  }
}

// Edit Task Modal Functions
function editTaskModal(taskId) {
  // Get current view from URL
  const currentView = new URLSearchParams(window.location.search).get('view') || 'list';
  
  // Set form action with view parameter
  document.getElementById('editTaskForm').action = `/edit/${taskId}?view=${currentView}`;
  
  // Clear form
  document.getElementById('editTaskContent').value = '';
  document.getElementById('editTaskPriority').value = 'low';
  document.getElementById('editTaskDueDate').value = '';
  
  // Try to get current task data from the DOM
  const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
  if (taskElement) {
    // Get current content
    const contentElement = taskElement.querySelector('p');
    if (contentElement) {
      document.getElementById('editTaskContent').value = contentElement.textContent.trim();
    }
    
    // Try to determine priority from badge color
    const priorityBadge = taskElement.querySelector('.badge');
    if (priorityBadge) {
      if (priorityBadge.classList.contains('bg-danger') || priorityBadge.textContent.includes('ÔøΩ')) {
        document.getElementById('editTaskPriority').value = 'high';
      } else if (priorityBadge.classList.contains('bg-warning') || priorityBadge.textContent.includes('üü°')) {
        document.getElementById('editTaskPriority').value = 'medium';
      } else {
        document.getElementById('editTaskPriority').value = 'low';
      }
    }
  }
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
  modal.show();
}

// Initialize Kanban board when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded');
  
  // Initialize theme
  initTheme();
  
  if (window.location.search.includes('view=kanban')) {
    console.log('Kanban view detected, initializing board...');
    
    // Add a small delay to ensure all elements are rendered
    setTimeout(() => {
      initKanbanBoard();
    }, 100);
  }
  
  // Initialize search and filter functionality
  initSearchAndFilter();
  
  // Highlight active view in navbar
  const currentView = new URLSearchParams(window.location.search).get('view') || 'list';
  const viewBtn = document.getElementById(currentView + '-view-btn');
  if (viewBtn) {
    viewBtn.classList.add('active');
  }
});

// Theme Management
function initTheme() {
  // Check for saved theme preference or default to 'light'
  const savedTheme = localStorage.getItem('taskflow-theme') || 'light';
  setTheme(savedTheme);
}

function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  setTheme(newTheme);
}

function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('taskflow-theme', theme);
  
  const themeIcon = document.getElementById('themeIcon');
  if (themeIcon) {
    if (theme === 'dark') {
      themeIcon.className = 'bi bi-sun-fill';
    } else {
      themeIcon.className = 'bi bi-moon-fill';
    }
  }
  
  // Update the theme toggle button title
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.title = theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
  }
}

// Search and Filter Functionality
function initSearchAndFilter() {
  const searchInput = document.getElementById('searchInput');
  const priorityFilter = document.getElementById('priorityFilter');
  const statusFilter = document.getElementById('statusFilter');
  const dueDateFilter = document.getElementById('dueDateFilter');
  const clearFiltersBtn = document.getElementById('clearFilters');
  const clearSearchBtn = document.getElementById('clearSearch');
  
  // Real-time search
  if (searchInput) {
    searchInput.addEventListener('input', applyFilters);
    clearSearchBtn.addEventListener('click', function() {
      searchInput.value = '';
      applyFilters();
    });
  }
  
  // Filter dropdowns
  if (priorityFilter) priorityFilter.addEventListener('change', applyFilters);
  if (statusFilter) statusFilter.addEventListener('change', applyFilters);
  if (dueDateFilter) dueDateFilter.addEventListener('change', applyFilters);
  
  // Clear all filters
  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', function() {
      if (searchInput) searchInput.value = '';
      if (priorityFilter) priorityFilter.value = '';
      if (statusFilter) statusFilter.value = '';
      if (dueDateFilter) dueDateFilter.value = '';
      applyFilters();
    });
  }
}

function applyFilters() {
  const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
  const priorityFilter = document.getElementById('priorityFilter')?.value || '';
  const statusFilter = document.getElementById('statusFilter')?.value || '';
  const dueDateFilter = document.getElementById('dueDateFilter')?.value || '';
  
  const currentView = new URLSearchParams(window.location.search).get('view') || 'list';
  let taskElements;
  
  if (currentView === 'kanban') {
    taskElements = document.querySelectorAll('.kanban-task');
  } else {
    // For list view, get the column divs that contain the task cards
    taskElements = document.querySelectorAll('.task-card').length > 0 
      ? Array.from(document.querySelectorAll('.task-card')).map(card => card.closest('.col-md-6, .col-lg-4'))
      : document.querySelectorAll('[class*="col-md-6"], [class*="col-lg-4"]');
  }
  
  let visibleCount = 0;
  
  taskElements.forEach(taskElement => {
    const shouldShow = matchesFilters(taskElement, searchTerm, priorityFilter, statusFilter, dueDateFilter);
    
    if (shouldShow) {
      taskElement.classList.remove('task-hidden');
      visibleCount++;
    } else {
      taskElement.classList.add('task-hidden');
    }
  });
  
  // Update active filters display
  updateActiveFiltersDisplay(searchTerm, priorityFilter, statusFilter, dueDateFilter);
  
  // Update column counters for Kanban view
  if (currentView === 'kanban') {
    updateKanbanCounters();
  }
  
  // Show no results message if needed
  showNoResultsMessage(visibleCount === 0 && (searchTerm || priorityFilter || statusFilter || dueDateFilter));
}

function matchesFilters(taskElement, searchTerm, priorityFilter, statusFilter, dueDateFilter) {
  // Get task content
  const taskContent = taskElement.querySelector('p, .card-text')?.textContent.toLowerCase() || '';
  
  // Search term filter
  if (searchTerm && !taskContent.includes(searchTerm)) {
    return false;
  }
  
  // Priority filter
  if (priorityFilter) {
    const priorityBadge = taskElement.querySelector('.badge');
    if (!priorityBadge) return false;
    
    const hasPriority = 
      (priorityFilter === 'high' && (priorityBadge.classList.contains('bg-danger') || priorityBadge.textContent.includes('üî¥'))) ||
      (priorityFilter === 'medium' && (priorityBadge.classList.contains('bg-warning') || priorityBadge.textContent.includes('üü°'))) ||
      (priorityFilter === 'low' && (priorityBadge.classList.contains('bg-success') || priorityBadge.textContent.includes('üü¢')));
    
    if (!hasPriority) return false;
  }
  
  // Status filter
  if (statusFilter) {
    const currentView = new URLSearchParams(window.location.search).get('view') || 'list';
    
    if (currentView === 'kanban') {
      const parentColumn = taskElement.closest('.kanban-tasks');
      if (!parentColumn) return false;
      
      const columnStatus = parentColumn.parentElement.dataset.status;
      if (columnStatus !== statusFilter) return false;
    } else {
      // For list view, check checkbox state
      const checkbox = taskElement.querySelector('input[type="checkbox"]');
      const isCompleted = checkbox?.checked || false;
      
      if (statusFilter === 'done' && !isCompleted) return false;
      if (statusFilter === 'todo' && isCompleted) return false;
      if (statusFilter === 'in_progress') {
        // For list view, we don't have in_progress state, so show nothing
        return false;
      }
    }
  }
  
  // Due date filter
  if (dueDateFilter) {
    const dueDateElement = taskElement.querySelector('.due-date-indicator');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (dueDateFilter === 'no_date' && dueDateElement) return false;
    if (dueDateFilter !== 'no_date' && !dueDateElement) return false;
    
    if (dueDateElement) {
      const dueDateText = dueDateElement.textContent.toLowerCase();
      
      switch (dueDateFilter) {
        case 'overdue':
          if (!dueDateText.includes('overdue')) return false;
          break;
        case 'today':
          if (!dueDateText.includes('due today')) return false;
          break;
        case 'tomorrow':
          if (!dueDateText.includes('due tomorrow')) return false;
          break;
        case 'this_week':
          if (!dueDateText.includes('due in') || dueDateText.includes('overdue')) return false;
          break;
      }
    }
  }
  
  return true;
}

function updateActiveFiltersDisplay(searchTerm, priorityFilter, statusFilter, dueDateFilter) {
  const activeFiltersDiv = document.getElementById('activeFilters');
  const filterTagsDiv = document.getElementById('filterTags');
  
  if (!activeFiltersDiv || !filterTagsDiv) return;
  
  let filterTags = '';
  
  if (searchTerm) {
    filterTags += `<span class="filter-tag">Search: "${searchTerm}" <button type="button" class="btn-close btn-close-white" onclick="clearSpecificFilter('search')"></button></span>`;
  }
  
  if (priorityFilter) {
    const priorityText = priorityFilter === 'high' ? 'üî¥ High' : priorityFilter === 'medium' ? 'üü° Medium' : 'üü¢ Low';
    filterTags += `<span class="filter-tag">Priority: ${priorityText} <button type="button" class="btn-close btn-close-white" onclick="clearSpecificFilter('priority')"></button></span>`;
  }
  
  if (statusFilter) {
    const statusText = statusFilter === 'todo' ? 'üìã To Do' : statusFilter === 'in_progress' ? '‚ö° In Progress' : '‚úÖ Done';
    filterTags += `<span class="filter-tag">Status: ${statusText} <button type="button" class="btn-close btn-close-white" onclick="clearSpecificFilter('status')"></button></span>`;
  }
  
  if (dueDateFilter) {
    const dueDateText = {
      'overdue': 'üî¥ Overdue',
      'today': 'üìÖ Due Today', 
      'tomorrow': '‚è∞ Due Tomorrow',
      'this_week': 'üìÜ This Week',
      'no_date': 'üìù No Due Date'
    }[dueDateFilter];
    filterTags += `<span class="filter-tag">Due: ${dueDateText} <button type="button" class="btn-close btn-close-white" onclick="clearSpecificFilter('dueDate')"></button></span>`;
  }
  
  if (filterTags) {
    filterTagsDiv.innerHTML = filterTags;
    activeFiltersDiv.classList.remove('d-none');
  } else {
    activeFiltersDiv.classList.add('d-none');
  }
}

function clearSpecificFilter(filterType) {
  switch (filterType) {
    case 'search':
      document.getElementById('searchInput').value = '';
      break;
    case 'priority':
      document.getElementById('priorityFilter').value = '';
      break;
    case 'status':
      document.getElementById('statusFilter').value = '';
      break;
    case 'dueDate':
      document.getElementById('dueDateFilter').value = '';
      break;
  }
  applyFilters();
}

function updateKanbanCounters() {
  const todoCount = document.querySelectorAll('#todo-tasks .kanban-task:not(.task-hidden)').length;
  const progressCount = document.querySelectorAll('#in_progress-tasks .kanban-task:not(.task-hidden)').length;
  const doneCount = document.querySelectorAll('#done-tasks .kanban-task:not(.task-hidden)').length;
  
  const todoBadge = document.querySelector('.kanban-todo .badge');
  const progressBadge = document.querySelector('.kanban-progress .badge');
  const doneBadge = document.querySelector('.kanban-done .badge');
  
  if (todoBadge) todoBadge.textContent = todoCount;
  if (progressBadge) progressBadge.textContent = progressCount;
  if (doneBadge) doneBadge.textContent = doneCount;
}

function showNoResultsMessage(show) {
  let noResultsDiv = document.getElementById('noResultsMessage');
  
  if (show && !noResultsDiv) {
    noResultsDiv = document.createElement('div');
    noResultsDiv.id = 'noResultsMessage';
    noResultsDiv.className = 'no-results';
    noResultsDiv.innerHTML = `
      <i class="bi bi-search" style="font-size: 3rem; color: #dee2e6;"></i>
      <h5 class="mt-3">No tasks found</h5>
      <p>Try adjusting your search terms or filters.</p>
    `;
    
    // Insert after the search section
    const searchSection = document.querySelector('.search-filter-section');
    if (searchSection) {
      searchSection.parentNode.insertBefore(noResultsDiv, searchSection.nextSibling);
    }
  } else if (!show && noResultsDiv) {
    noResultsDiv.remove();
  }
}
</script>
</body>
</html>
