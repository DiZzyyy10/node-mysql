<!DOCTYPE html>
<html lang="<%= currentLang %>">
<head>
  <title><%= title %></title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="TaskFlow - Your personal productivity companion">
  <meta name="author" content="TaskFlow">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Modern Design System Variables */
    :root {
      --primary: #667eea;
      --primary-light: #8b9cf7;
      --primary-rgb: 102, 126, 234;
      
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-primary-hover: linear-gradient(135deg, #5a6fd8 0%, #6b4190 100%);
      --success-gradient: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      --warning-gradient: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      --danger-gradient: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      
      /* Glass Effects */
      --glass-bg: rgba(255, 255, 255, 0.75);
      --glass-bg-dark: rgba(45, 55, 72, 0.75);
      --glass-bg-muted: rgba(255, 255, 255, 0.5);
      
      /* Borders */
      --border-color: rgba(226, 232, 240, 0.8);
      --border-color-dark: rgba(74, 85, 104, 0.6);
      --border-color-light: rgba(226, 232, 240, 0.4);
      
      /* Text Colors */
      --text-muted: #718096;
      
      --surface-light: rgba(255, 255, 255, 0.8);
      --surface-dark: rgba(45, 55, 72, 0.8);
      --glass-effect: blur(20px);
      
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.12);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.15);
      --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.25);
      
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 24px;
      --border-radius-full: 9999px;
      
      --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-xxl: 3rem;
    }
    
    /* Modern Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      min-height: 100vh;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
      line-height: 1.6;
      color: #2d3748;
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    body {
      padding-top: 0 !important;
    }
    
    /* Modern Navbar Styling */
    .navbar {
      margin: 0 !important;
      border-radius: 0 !important;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95)) !important;
      backdrop-filter: var(--glass-effect);
      border-bottom: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: var(--shadow-sm);
      padding: var(--spacing-md) 0;
    }
    
    .navbar-brand {
      font-weight: 700 !important;
      font-size: 1.5rem !important;
      color: white !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .nav-link {
      font-weight: 500 !important;
      border-radius: var(--border-radius-md) !important;
      margin: 0 var(--spacing-xs) !important;
      transition: var(--transition-fast) !important;
      color: rgba(255, 255, 255, 0.9) !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.2) !important;
      transform: translateY(-1px);
      border-radius: var(--border-radius-md);
      color: white !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .nav-link.active {
      background: rgba(255, 255, 255, 0.25) !important;
      color: white !important;
      box-shadow: var(--shadow-sm);
      font-weight: 600 !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    /* Navbar Text Colors */
    .navbar-nav .nav-link {
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .navbar-nav .nav-link:hover,
    .navbar-nav .nav-link:focus {
      color: white !important;
    }
    
    .navbar-toggler {
      border-color: rgba(255, 255, 255, 0.3) !important;
    }
    
    .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.9%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e") !important;
    }
    
    .container {
      margin-top: var(--spacing-xl);
      max-width: 1200px;
      overflow: visible;
      padding-bottom: var(--spacing-xxl);
    }
    body {
      background-color: #f8f9fa;
    }
    .task-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .add-task-form {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(226, 232, 240, 0.6);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
      margin-bottom: var(--spacing-xl);
      transition: all var(--transition-smooth);
    }
    
    .add-task-form:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }
    .task-completed {
      opacity: 0.6;
      background: var(--glass-bg-muted);
      border-color: var(--border-color-light);
    }
    
    .task-completed .card-text {
      text-decoration: line-through;
      color: var(--text-muted);
    }
    .task-checkbox {
      transform: scale(1.3);
      margin-right: var(--spacing-sm);
      accent-color: var(--primary);
      cursor: pointer;
    }
    .task-actions {
      opacity: 0;
      transition: all var(--transition-smooth);
      transform: translateY(4px);
    }
    
    .task-card:hover .task-actions {
      opacity: 1;
      transform: translateY(0);
    }
    .edit-form {
      display: none;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-md);
      margin-top: var(--spacing-sm);
      box-shadow: var(--shadow-md);
      animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .btn-sm {
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: 0.875rem;
      border-radius: var(--border-radius-md);
      font-weight: 500;
      transition: all var(--transition-smooth);
    }
    
    .btn-sm:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    .priority-indicator {
      width: 4px;
      height: 100%;
      position: absolute;
      left: 0;
      top: 0;
      border-radius: var(--border-radius-md) 0 0 var(--border-radius-md);
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
    }
    
    .priority-high { 
      background: linear-gradient(135deg, #dc3545, #ff6b7a) !important;
      box-shadow: 0 0 15px rgba(220, 53, 69, 0.3);
    }
    
    .priority-medium { 
      background: linear-gradient(135deg, #ffc107, #ffeb3b) !important;
      box-shadow: 0 0 15px rgba(255, 193, 7, 0.3);
    }
    
    .priority-low { 
      background: linear-gradient(135deg, #198754, #28a745) !important;
      box-shadow: 0 0 15px rgba(25, 135, 84, 0.3);
    }
    .priority-badge {
      font-size: 0.75rem;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius-full);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--glass-bg);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-color);
    }
    .task-card {
      position: relative;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(226, 232, 240, 0.7);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      box-shadow: var(--shadow-md);
      transition: all var(--transition-smooth);
      overflow: hidden;
    }
    
    .task-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
      border-color: var(--primary-light);
    }
    .due-date-indicator {
      font-size: 0.75rem;
      font-weight: 500;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius-full);
      background: var(--glass-bg);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-color);
    }
    
    .due-today {
      color: #fd7e14;
      font-weight: 600;
      background: linear-gradient(135deg, rgba(253, 126, 20, 0.1), rgba(253, 126, 20, 0.05));
      border-color: rgba(253, 126, 20, 0.2);
    }
    
    .due-overdue {
      color: #dc3545;
      font-weight: 600;
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
      border-color: rgba(220, 53, 69, 0.2);
    }
    
    .due-upcoming {
      color: #6f42c1;
      background: linear-gradient(135deg, rgba(111, 66, 193, 0.1), rgba(111, 66, 193, 0.05));
      border-color: rgba(111, 66, 193, 0.2);
    }
    
    /* Kanban Board Styles */
    .kanban-board {
      display: flex;
      gap: var(--spacing-lg);
      overflow-x: auto;
      overflow-y: visible;
      padding: var(--spacing-lg) 0 var(--spacing-xxl) 0;
      scroll-behavior: smooth;
      margin-bottom: var(--spacing-xl);
    }
    
    .kanban-column {
      flex: 1;
      min-width: 320px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(226, 232, 240, 0.7);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      transition: all var(--transition-smooth);
      overflow: visible;
    }
    
    .kanban-column:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .kanban-header {
      text-align: center;
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
      border-radius: var(--border-radius-md);
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      background: var(--glass-bg);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }
    
    .kanban-todo { 
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05));
      border-color: rgba(33, 150, 243, 0.2);
      color: #1976d2;
    }
    
    .kanban-progress { 
      background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.05));
      border-color: rgba(255, 152, 0, 0.2);
      color: #f57c00;
    }
    
    .kanban-done { 
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
      border-color: rgba(76, 175, 80, 0.2);
      color: #388e3c;
    }
    
    .kanban-task {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(226, 232, 240, 0.7);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
      box-shadow: var(--shadow-sm);
      cursor: move;
      transition: all var(--transition-smooth);
      position: relative;
      overflow: hidden;
    }
    
    .kanban-task::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity var(--transition-smooth);
    }
    
    .kanban-task:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-light);
    }
    
    .kanban-task:hover::before {
      opacity: 1;
    }
    .kanban-task.dragging {
      opacity: 0.7;
      transform: rotate(3deg) scale(1.05);
      box-shadow: var(--shadow-xl);
      border-color: var(--primary);
    }
    
    .kanban-tasks.drag-over {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05));
      border: 2px dashed var(--primary);
      border-radius: var(--border-radius-lg);
      min-height: 200px;
      box-shadow: inset 0 0 20px rgba(33, 150, 243, 0.1);
    }
    .kanban-tasks {
      min-height: 180px;
      padding: var(--spacing-sm) var(--spacing-sm) var(--spacing-lg) var(--spacing-sm);
      border-radius: var(--border-radius-md);
      transition: all var(--transition-smooth);
      overflow: visible;
    }
    .nav-link.active {
      background: rgba(255, 255, 255, 0.85) !important;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(102, 126, 234, 0.3);
      border-radius: var(--border-radius-md);
      color: var(--primary) !important;
      font-weight: 600;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    /* View Navigation Buttons - Make them highly visible */
    #list-view-btn,
    #kanban-view-btn {
      background: rgba(255, 255, 255, 0.15) !important;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--border-radius-md);
      color: rgba(255, 255, 255, 0.9) !important;
      font-weight: 500;
      margin: 0 var(--spacing-xs);
      transition: all var(--transition-smooth);
    }
    
    #list-view-btn:hover,
    #kanban-view-btn:hover {
      background: rgba(255, 255, 255, 0.25) !important;
      border-color: rgba(255, 255, 255, 0.4);
      color: white !important;
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    #list-view-btn.active,
    #kanban-view-btn.active {
      background: rgba(255, 255, 255, 0.9) !important;
      border-color: rgba(102, 126, 234, 0.5);
      color: var(--primary) !important;
      font-weight: 600;
    }
    
    /* Search & Filter Styling */
    .search-filter-section {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(226, 232, 240, 0.6);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--spacing-lg);
      transition: all var(--transition-smooth);
    }
    
    .search-filter-section:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .filter-tag {
      display: inline-block;
      background: var(--gradient-primary);
      color: white;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius-full);
      font-size: 0.85rem;
      font-weight: 500;
      margin: var(--spacing-xs);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-smooth);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .filter-tag:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .filter-tag .btn-close {
      font-size: 0.7rem;
      margin-left: var(--spacing-xs);
      filter: invert(1);
      opacity: 0.8;
      transition: opacity var(--transition-smooth);
    }
    
    .filter-tag .btn-close:hover {
      opacity: 1;
    }
    
    .task-hidden {
      display: none !important;
    }
    
    .no-results {
      text-align: center;
      padding: var(--spacing-xxl);
      color: var(--text-muted);
      background: var(--glass-bg);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      margin: var(--spacing-lg) 0;
    }
    
    #searchInput:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
      transform: translateY(-1px);
    }
    
    /* Dark Mode Styles */
    [data-theme="dark"] {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
      color: #e0e0e0 !important;
      min-height: 100vh !important;
    }
    
    [data-theme="dark"] body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
      color: #e0e0e0 !important;
      min-height: 100vh !important;
    }
    
    [data-theme="dark"] html {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
      min-height: 100vh !important;
    }
    
    [data-theme="dark"] .navbar {
      background: linear-gradient(135deg, rgba(26, 32, 44, 0.95), rgba(45, 55, 72, 0.95)) !important;
      border-bottom-color: rgba(74, 85, 104, 0.8);
    }
    
    [data-theme="dark"] .navbar-brand {
      color: white !important;
    }
    
    [data-theme="dark"] .nav-link {
      color: rgba(224, 224, 224, 0.9) !important;
    }
    
    [data-theme="dark"] .nav-link:hover,
    [data-theme="dark"] .nav-link:focus {
      color: white !important;
      background: rgba(255, 255, 255, 0.1) !important;
    }
    
    [data-theme="dark"] .nav-link.active {
      background: rgba(255, 255, 255, 0.15) !important;
      color: white !important;
    }
    
    /* Navbar Theme Toggle Button Styling */
    .navbar #navThemeToggle {
      background: none !important;
      border: none !important;
      color: #ffffff !important;
      font-size: 1.1rem;
      padding: 8px 12px !important;
      margin: 0 4px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    
    .navbar #navThemeToggle:hover {
      background-color: rgba(255,255,255,0.1) !important;
      transform: scale(1.1);
    }
    
    .navbar #navThemeToggle:focus {
      box-shadow: 0 0 0 2px rgba(255,255,255,0.3) !important;
    }
    
    [data-theme="dark"] .navbar #navThemeToggle {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .navbar #navThemeToggle:hover {
      background-color: rgba(255,255,255,0.1) !important;
    }
    
    [data-theme="dark"] .container {
      background: transparent !important;
    }
    
    [data-theme="dark"] .container-fluid {
      background: transparent !important;
    }
    
    [data-theme="dark"] .add-task-form {
      background: rgba(45, 55, 72, 0.9);
      border-color: rgba(74, 85, 104, 0.7);
    }
    
    [data-theme="dark"] .search-filter-section {
      background: rgba(45, 55, 72, 0.9);
      border-color: rgba(74, 85, 104, 0.7);
    }
    
    /* Dark Mode Navigation */
    [data-theme="dark"] .nav-link.active {
      background: rgba(45, 55, 72, 0.9) !important;
      border-color: rgba(102, 126, 234, 0.5) !important;
      color: #a5b4fc !important;
    }
    
    [data-theme="dark"] .nav-link:hover {
      background: rgba(102, 126, 234, 0.2) !important;
    }
    
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-select {
      background-color: var(--glass-bg-dark);
      border-color: var(--border-color-dark);
      color: #e0e0e0 !important;
      backdrop-filter: blur(8px);
    }
    
    [data-theme="dark"] .form-control::placeholder {
      color: #adb5bd !important;
      opacity: 1;
    }
    
    [data-theme="dark"] .form-control:focus,
    [data-theme="dark"] .form-select:focus {
      background-color: var(--glass-bg-dark);
      border-color: var(--primary);
      color: #e0e0e0 !important;
      box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
      transform: translateY(-1px);
    }
    
    [data-theme="dark"] .form-control:focus::placeholder {
      color: #adb5bd !important;
    }
    
    [data-theme="dark"] .btn-primary {
      background: var(--gradient-primary);
      border: 1px solid var(--primary);
      box-shadow: var(--shadow-sm);
    }
    
    [data-theme="dark"] .btn-primary:hover {
      background: var(--gradient-primary-hover);
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    [data-theme="dark"] .btn-outline-secondary {
      color: #adb5bd;
      border-color: #6c757d;
    }
    
    [data-theme="dark"] .btn-outline-secondary:hover {
      color: #212529;
      background-color: #adb5bd;
      border-color: #adb5bd;
    }
    
    [data-theme="dark"] .btn-outline-danger {
      color: #dc3545;
      border-color: #dc3545;
    }
    
    [data-theme="dark"] .btn-outline-danger:hover {
      color: #fff;
      background-color: #dc3545;
      border-color: #dc3545;
    }
    
    /* Dark Mode Cards */
    [data-theme="dark"] .card {
      background: rgba(45, 55, 72, 0.9);
      border-color: rgba(74, 85, 104, 0.7);
      color: #e0e0e0 !important;
      backdrop-filter: blur(12px);
    }
    
    [data-theme="dark"] .card-body {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .card-text {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .task-card {
      background: rgba(45, 55, 72, 0.9);
      border-color: rgba(74, 85, 104, 0.7);
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .task-card p {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .task-card .card-text {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .task-card:hover {
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-light);
    }
    
    /* Dark Mode Kanban */
    [data-theme="dark"] .kanban-board {
      background-color: transparent;
    }
    
    [data-theme="dark"] .kanban-column {
      background: rgba(45, 55, 72, 0.9);
      border-color: rgba(74, 85, 104, 0.7);
    }
    
    [data-theme="dark"] .kanban-header {
      background: rgba(45, 55, 72, 0.9);
      border-color: rgba(74, 85, 104, 0.7);
      color: #e0e0e0;
    }
    
    [data-theme="dark"] .kanban-task {
      background: rgba(45, 55, 72, 0.9);
      border-color: rgba(74, 85, 104, 0.7);
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .kanban-task p {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .kanban-task .card-text {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .kanban-task .task-content {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .kanban-task:hover {
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-light);
    }
    
    [data-theme="dark"] .kanban-tasks.drag-over {
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(33, 150, 243, 0.1));
      border: 2px dashed var(--primary);
      box-shadow: inset 0 0 20px rgba(33, 150, 243, 0.2);
    }
    
    /* Dark Mode Modal */
    [data-theme="dark"] .modal-content {
      background: var(--glass-bg-dark);
      backdrop-filter: blur(16px);
      color: #e0e0e0;
      border: 1px solid var(--border-color-dark);
      box-shadow: var(--shadow-xl);
    }
    
    [data-theme="dark"] .modal-header {
      border-bottom-color: var(--border-color-dark);
    }
    
    [data-theme="dark"] .modal-footer {
      border-top-color: var(--border-color-dark);
    }
    
    [data-theme="dark"] .btn-close {
      filter: invert(1);
    }
    
    /* Dark Mode Text Colors */
    [data-theme="dark"] .text-muted {
      color: #adb5bd !important;
    }
    
    [data-theme="dark"] .due-date-indicator {
      color: #adb5bd !important;
    }
    
    [data-theme="dark"] h1, 
    [data-theme="dark"] h2, 
    [data-theme="dark"] h3, 
    [data-theme="dark"] h4, 
    [data-theme="dark"] h5, 
    [data-theme="dark"] h6 {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] p {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] span {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .task-display p {
      color: #e0e0e0 !important;
    }
    
    [data-theme="dark"] .task-edit input {
      color: #e0e0e0 !important;
      background-color: #3d3d3d !important;
      border-color: #555 !important;
    }
    
    [data-theme="dark"] .task-edit input::placeholder {
      color: #adb5bd !important;
    }
    
    /* Dark Mode Badges */
    [data-theme="dark"] .badge.bg-primary {
      background-color: #0d6efd !important;
    }
    
    [data-theme="dark"] .badge.bg-success {
      background-color: #198754 !important;
    }
    
    [data-theme="dark"] .badge.bg-warning {
      background-color: #ffc107 !important;
      color: #212529 !important;
    }
    
    [data-theme="dark"] .badge.bg-danger {
      background-color: #dc3545 !important;
    }
    
    /* Mobile Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .add-task-form {
        padding: 15px;
        margin-bottom: 20px;
      }
      
      .add-task-form .row {
        flex-direction: column;
      }
      
      .add-task-form .col-md-6,
      .add-task-form .col-md-2 {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .search-filter-section {
        padding: 15px;
      }
      
      .search-filter-section .row {
        flex-direction: column;
      }
      
      .search-filter-section .col-md-4,
      .search-filter-section .col-md-2 {
        width: 100%;
        margin-bottom: 10px;
      }
      
      /* Mobile Kanban */
      .kanban-board {
        flex-direction: column;
        gap: 15px;
      }
      
      .kanban-column {
        width: 100% !important;
        min-height: 200px;
      }
      
      .kanban-task {
        margin-bottom: 10px;
        padding: 12px;
      }
      
      .kanban-header {
        padding: 12px;
        font-size: 1rem;
      }
      
      /* Mobile List View */
      .task-card {
        margin-bottom: 15px;
      }
      
      .card-body {
        padding: 15px;
      }
      
      /* Mobile Navigation */
      .navbar-brand {
        font-size: 1.1rem;
      }
      
      .nav-link {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
      
      /* Mobile Modal */
      .modal-dialog {
        margin: 10px;
      }
      
      .modal-content {
        border-radius: 8px;
      }
      
      /* Mobile Forms */
      .form-control-lg {
        padding: 10px 12px;
        font-size: 1rem;
      }
      
      .form-select-lg {
        padding: 10px 12px;
        font-size: 1rem;
      }
      
      .btn-lg {
        padding: 10px 16px;
        font-size: 1rem;
      }
      
      /* Mobile Priority Indicators */
      .priority-indicator {
        width: 4px;
        height: 100%;
      }
      
      .kanban-task .priority-indicator {
        width: 3px;
      }
    }
    
    /* Tablet Responsive Design */
    @media (min-width: 769px) and (max-width: 1024px) {
      .kanban-column {
        width: 32%;
      }
      
      .container {
        max-width: 95%;
      }
      
      .search-filter-section .col-md-4 {
        flex: 0 0 40%;
      }
      
      .search-filter-section .col-md-2 {
        flex: 0 0 20%;
      }
    }
    
    /* Large Screen Optimizations */
    @media (min-width: 1200px) {
      .kanban-column {
        width: 31%;
      }
      
      .container {
        max-width: 1400px;
      }
      
      .kanban-task {
        margin-bottom: 12px;
      }
    }
    
    /* Dark Mode Full Page Coverage */
    [data-theme="dark"]::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #121212;
      z-index: -1;
    }
    
    [data-theme="dark"] * {
      scrollbar-color: #555 #121212;
    }
    
    [data-theme="dark"]::-webkit-scrollbar {
      width: 12px;
    }
    
    [data-theme="dark"]::-webkit-scrollbar-track {
      background: #121212;
    }
    
    [data-theme="dark"]::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 6px;
    }
    
    [data-theme="dark"]::-webkit-scrollbar-thumb:hover {
      background: #777;
    }
    
    /* Japanese Language Support */
    [lang="ja"] {
      font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, "Yu Gothic", "MS PGothic", sans-serif;
      line-height: 1.6;
    }
    
    [lang="ja"] .navbar-brand {
      font-weight: 600;
    }
    
    [lang="ja"] h1, [lang="ja"] h2, [lang="ja"] h3, [lang="ja"] h4, [lang="ja"] h5, [lang="ja"] h6 {
      font-weight: 600;
      line-height: 1.4;
    }
    
    [lang="ja"] .btn {
      font-weight: 500;
    }
    
    /* Touch Device Optimizations */
    @media (hover: none) and (pointer: coarse) {
      .kanban-task {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .btn {
        padding: 12px 20px;
        font-size: 1rem;
      }
      
      .form-control,
      .form-select {
        padding: 12px;
        font-size: 1rem;
      }
      
      .kanban-task:hover {
        transform: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .task-card:hover {
        transform: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
    }
  </style>
</head>
<body>

<%- include('./header'); %>
<%- include('./error_messages'); %>
<% if(isAuth) { %>
<div class="container mt-4">
  <!-- Add Task Form -->
  <div class="add-task-form">
    <h4 class="mb-3">
      <i class="bi bi-plus-circle"></i> <%= __('tasks.add_new_task') %>
    </h4>
    <form action="/" method="post" onsubmit="addViewParam(this)">
      <div class="row g-2">
        <div class="col-md-6">
          <input 
            required 
            type="text" 
            name="add" 
            class="form-control form-control-lg" 
            placeholder="<%= __('tasks.task_placeholder') %>"
          />
        </div>
        <div class="col-md-2">
          <select name="priority" class="form-select form-select-lg">
            <option value="low"><%= __('priority.low') %></option>
            <option value="medium" selected><%= __('priority.medium') %></option>
            <option value="high"><%= __('priority.high') %></option>
          </select>
        </div>
        <div class="col-md-2">
          <input 
            type="date" 
            name="due_date" 
            class="form-control form-control-lg"
            min="<%= new Date().toISOString().split('T')[0] %>"
          />
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-plus"></i> <%= __('tasks.add_task') %>
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Search & Filter Controls -->
  <div class="search-filter-section mb-4">
    <div class="row g-3">
      <!-- Search Bar -->
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input 
            type="text" 
            id="searchInput" 
            class="form-control" 
            placeholder="<%= __('search.search_tasks') %>"
            autocomplete="off"
          />
          <button class="btn btn-outline-secondary" type="button" id="clearSearch" title="Clear search">
            <i class="bi bi-x"></i>
          </button>
        </div>
      </div>

      <!-- Priority Filter -->
      <div class="col-md-2">
        <select id="priorityFilter" class="form-select">
          <option value=""><%= __('search.all_priorities') %></option>
          <option value="high"><%= __('priority.high') %></option>
          <option value="medium"><%= __('priority.medium') %></option>
          <option value="low"><%= __('priority.low') %></option>
        </select>
      </div>

      <!-- Status Filter -->
      <div class="col-md-2">
        <select id="statusFilter" class="form-select">
          <option value=""><%= __('search.all_status') %></option>
          <option value="todo"><%= __('status.todo') %></option>
          <option value="in_progress"><%= __('status.in_progress') %></option>
          <option value="done"><%= __('status.done') %></option>
        </select>
      </div>

      <!-- Due Date Filter -->
      <div class="col-md-2">
        <select id="dueDateFilter" class="form-select">
          <option value=""><%= __('search.all_due_dates') %></option>
          <option value="overdue"><%= __('due_dates.overdue') %></option>
          <option value="today"><%= __('due_dates.due_today') %></option>
          <option value="tomorrow"><%= __('due_dates.due_tomorrow') %></option>
          <option value="this_week"><%= __('due_dates.this_week') %></option>
          <option value="no_date"><%= __('due_dates.no_date') %></option>
        </select>
      </div>

      <!-- Clear All Filters -->
      <div class="col-md-2">
        <button class="btn btn-outline-danger w-100" id="clearFilters" title="<%= __('search.clear_filters') %>">
          <i class="bi bi-funnel"></i> <%= __('search.clear_filters') %>
        </button>
      </div>
    </div>

    <!-- Active Filters Display -->
    <div id="activeFilters" class="mt-2 d-none">
      <small class="text-muted">Active filters:</small>
      <div id="filterTags" class="d-inline"></div>
    </div>
  </div>

  <!-- Tasks Display -->
  <% if (view === 'kanban') { %>
    <!-- Kanban Board View -->
    <div class="kanban-board">
      <!-- To Do Column -->
      <div class="kanban-column" data-status="todo">
        <div class="kanban-header kanban-todo">
          <i class="bi bi-list-task"></i> <%= __('kanban.todo_column') %>
          <span class="badge bg-primary ms-2">
            <%= todos.filter(t => t.status === 'todo').length %>
          </span>
        </div>
        <div class="kanban-tasks" id="todo-tasks">
          <% todos.filter(t => t.status === 'todo').forEach(function(todo) { %>
            <%- include('partials/kanban-task', {todo: todo}) %>
          <% }) %>
        </div>
      </div>

      <!-- In Progress Column -->
      <div class="kanban-column" data-status="in_progress">
        <div class="kanban-header kanban-progress">
          <i class="bi bi-arrow-clockwise"></i> <%= __('kanban.progress_column') %>
          <span class="badge bg-warning ms-2">
            <%= todos.filter(t => t.status === 'in_progress').length %>
          </span>
        </div>
        <div class="kanban-tasks" id="in_progress-tasks">
          <% todos.filter(t => t.status === 'in_progress').forEach(function(todo) { %>
            <%- include('partials/kanban-task', {todo: todo}) %>
          <% }) %>
        </div>
      </div>

      <!-- Done Column -->
      <div class="kanban-column" data-status="done">
        <div class="kanban-header kanban-done">
          <i class="bi bi-check-circle"></i> <%= __('kanban.done_column') %>
          <span class="badge bg-success ms-2">
            <%= todos.filter(t => t.status === 'done').length %>
          </span>
        </div>
        <div class="kanban-tasks" id="done-tasks">
          <% todos.filter(t => t.status === 'done').forEach(function(todo) { %>
            <%- include('partials/kanban-task', {todo: todo}) %>
          <% }) %>
        </div>
      </div>
    </div>
  <% } else { %>
    <!-- List View -->
    <div class="row">
      <div class="col-12">
        <h4 class="mb-3">
          <i class="bi bi-list-task"></i> Your Tasks
          <span class="badge bg-primary ms-2">
            <%= todos.filter(t => !t.completed).length %> active
          </span>
          <% if (todos.filter(t => t.completed).length > 0) { %>
            <span class="badge bg-success ms-1">
              <%= todos.filter(t => t.completed).length %> completed
            </span>
          <% } %>
        </h4>
        
        <% if(todos.length === 0) { %>
          <div class="text-center py-5">
            <i class="bi bi-clipboard-check" style="font-size: 4rem; color: #dee2e6;"></i>
            <p class="text-muted mt-3">No tasks yet! Add your first task above.</p>
          </div>
        <% } else { %>
          <div class="row">
            <% for(let todo of todos){ %>
              <%- include('partials/list-task', {todo: todo}) %>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  <% } %>
</div>
<% } else { %>
  <div class="container text-center mt-5">
    <h1 class="display-4 mb-4">Welcome to TaskFlow</h1>
    <p class="lead mb-4">Your personal productivity companion</p>
    <a class="btn btn-primary btn-lg" href="/signup" role="button">
      <i class="bi bi-person-plus"></i> Get Started
    </a>
  </div>
<% } %>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editTaskForm" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editTaskContent" class="form-label">Task Description</label>
            <input type="text" class="form-control" id="editTaskContent" name="content" required>
          </div>
          <div class="mb-3">
            <label for="editTaskPriority" class="form-label">Priority</label>
            <select class="form-select" id="editTaskPriority" name="priority" required>
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editTaskDueDate" class="form-label">Due Date</label>
            <input type="date" class="form-control" id="editTaskDueDate" name="due_date">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function editTask(taskId) {
  // Hide display mode
  document.querySelector('.task-display-' + taskId).style.display = 'none';
  // Show edit mode
  document.querySelector('.task-edit-' + taskId).style.display = 'block';
  // Focus on the input
  document.querySelector('.task-edit-' + taskId + ' input').focus();
}

function cancelEdit(taskId) {
  // Show display mode
  document.querySelector('.task-display-' + taskId).style.display = 'block';
  // Hide edit mode
  document.querySelector('.task-edit-' + taskId).style.display = 'none';
}

function formatDueDate(dueDate) {
  if (!dueDate) return '';
  
  const today = new Date();
  const due = new Date(dueDate);
  const diffTime = due.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) {
    return { text: `Overdue by ${Math.abs(diffDays)} day(s)`, class: 'due-overdue' };
  } else if (diffDays === 0) {
    return { text: 'Due today', class: 'due-today' };
  } else if (diffDays === 1) {
    return { text: 'Due tomorrow', class: 'due-upcoming' };
  } else if (diffDays <= 7) {
    return { text: `Due in ${diffDays} days`, class: 'due-upcoming' };
  } else {
    return { text: `Due ${due.toLocaleDateString()}`, class: '' };
  }
}

// Kanban Board Functionality
function initKanbanBoard() {
  console.log('Initializing Kanban board...');
  const kanbanTasks = document.querySelectorAll('.kanban-task');
  const kanbanColumns = document.querySelectorAll('.kanban-tasks');
  
  console.log('Found tasks:', kanbanTasks.length);
  console.log('Found columns:', kanbanColumns.length);
  
  // Test if tasks are properly found
  kanbanTasks.forEach((task, index) => {
    console.log(`Task ${index}:`, task.dataset.taskId, 'draggable:', task.draggable);
  });
  
  // Add drag events to tasks
  kanbanTasks.forEach((task, index) => {
    console.log(`Adding drag events to task ${index}:`, task.dataset.taskId);
    
    // Ensure draggable is set
    task.draggable = true;
    
    task.addEventListener('dragstart', handleDragStart);
    task.addEventListener('dragend', handleDragEnd);
    
    // Add test click event to verify event handling works
    task.addEventListener('click', function(e) {
      if (!e.target.closest('button')) {
        console.log('Task clicked:', this.dataset.taskId);
      }
    });
  });
  
  // Add drop events to columns
  kanbanColumns.forEach((column, index) => {
    console.log(`Adding drop events to column ${index}:`, column.id);
    column.addEventListener('dragover', handleDragOver);
    column.addEventListener('drop', handleDrop);
    column.addEventListener('dragenter', handleDragEnter);
    column.addEventListener('dragleave', handleDragLeave);
  });
  
  // Also add events to the column containers for better drop zone coverage
  const columnContainers = document.querySelectorAll('.kanban-column');
  columnContainers.forEach((container, index) => {
    console.log(`Adding additional drop events to container ${index}:`, container.dataset.status);
    container.addEventListener('dragover', handleDragOver);
    container.addEventListener('dragenter', function(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      const tasksArea = this.querySelector('.kanban-tasks');
      if (tasksArea) {
        console.log('Container drag enter:', tasksArea.id);
        tasksArea.classList.add('drag-over');
      }
    });
    container.addEventListener('drop', function(e) {
      const tasksArea = this.querySelector('.kanban-tasks');
      if (tasksArea) {
        handleDrop.call(tasksArea, e);
      }
    });
  });
}

let draggedTask = null;

function handleDragStart(e) {
  console.log('Drag start:', this.dataset.taskId);
  draggedTask = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.outerHTML);
}

function handleDragEnd(e) {
  console.log('Drag end');
  this.classList.remove('dragging');
  // Don't reset draggedTask here - we need it in handleDrop
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDragEnter(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  console.log('Drag enter:', this.id);
  this.classList.add('drag-over');
  return false;
}

function handleDragLeave(e) {
  // Only remove drag-over if we're actually leaving this element
  if (!this.contains(e.relatedTarget)) {
    console.log('Drag leave:', this.id);
    this.classList.remove('drag-over');
  }
}

function handleDrop(e) {
  console.log('Drop event triggered on:', this.id);
  
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  if (e.preventDefault) {
    e.preventDefault();
  }
  
  this.classList.remove('drag-over');
  
  if (!draggedTask) {
    console.log('No dragged task found');
    return false;
  }
  
  const taskId = draggedTask.dataset.taskId;
  const newStatus = this.parentElement.dataset.status;
  const currentColumn = draggedTask.closest('.kanban-tasks');
  const oldStatus = currentColumn ? currentColumn.parentElement.dataset.status : null;
  
  console.log('Drop details:', { taskId, newStatus, oldStatus });
  
  if (newStatus !== oldStatus) {
    // Cross-column move (status change)
    console.log('Status changed, moving task...');
    this.appendChild(draggedTask);
    updateTaskStatus(taskId, newStatus);
  } else {
    // Intra-column reorder (same status, different position)
    console.log('Reordering within same column...');
    
    // Calculate new position based on drop location
    const dropY = e.clientY;
    const tasks = Array.from(this.children);
    let newPosition = tasks.length;
    
    // Find where to insert based on mouse position
    for (let i = 0; i < tasks.length; i++) {
      const task = tasks[i];
      if (task === draggedTask) continue;
      
      const rect = task.getBoundingClientRect();
      const taskMiddle = rect.top + rect.height / 2;
      
      if (dropY < taskMiddle) {
        newPosition = i;
        break;
      }
    }
    
    // Get current position of dragged task
    const currentPosition = tasks.indexOf(draggedTask);
    
    // Only reorder if position actually changed
    if (newPosition !== currentPosition && newPosition !== currentPosition + 1) {
      // Adjust position if moving down (account for removed element)
      if (newPosition > currentPosition) {
        newPosition--;
      }
      
      console.log('Reordering from position', currentPosition, 'to', newPosition);
      
      // Move the element visually
      if (newPosition >= tasks.length - 1) {
        this.appendChild(draggedTask);
      } else {
        this.insertBefore(draggedTask, this.children[newPosition]);
      }
      
      // Update on server
      updateTaskOrder(taskId, newPosition, newStatus);
    } else {
      console.log('Position unchanged, no reorder needed');
    }
  }
  
  // Reset dragged task
  draggedTask = null;
  
  return false;
}

function updateTaskStatus(taskId, newStatus) {
  console.log('Updating task status:', { taskId, newStatus });
  
  fetch(`/status/${taskId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({ status: newStatus }),
  })
  .then(response => {
    console.log('Response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Task status updated successfully:', data);
    // Update column counters
    updateColumnCounters();
  })
  .catch(error => {
    console.error('Error updating task status:', error);
    alert('Failed to update task status. Please try again.');
    // Reload page on error to ensure consistency
    window.location.reload();
  });
}

function updateTaskOrder(taskId, newPosition, status) {
  console.log('Updating task order:', { taskId, newPosition, status });
  
  fetch('/reorder', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({ 
      taskId: taskId, 
      newPosition: newPosition, 
      status: status 
    }),
  })
  .then(response => {
    console.log('Reorder response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Task order updated successfully:', data);
  })
  .catch(error => {
    console.error('Error updating task order:', error);
    alert('Failed to reorder task. Please try again.');
    // Reload page on error to ensure consistency
    window.location.reload();
  });
}

function updateColumnCounters() {
  const todoCount = document.querySelectorAll('#todo-tasks .kanban-task').length;
  const progressCount = document.querySelectorAll('#in_progress-tasks .kanban-task').length;
  const doneCount = document.querySelectorAll('#done-tasks .kanban-task').length;
  
  document.querySelector('.kanban-todo .badge').textContent = todoCount;
  document.querySelector('.kanban-progress .badge').textContent = progressCount;
  document.querySelector('.kanban-done .badge').textContent = doneCount;
}

function deleteTask(taskId) {
  if (confirm('Are you sure you want to delete this task?')) {
    const currentView = new URLSearchParams(window.location.search).get('view');
    const form = document.createElement('form');
    form.method = 'POST';
    
    // Include view in the action URL if present
    if (currentView) {
      form.action = `/delete/${taskId}?view=${currentView}`;
    } else {
      form.action = `/delete/${taskId}`;
    }
    
    document.body.appendChild(form);
    form.submit();
  }
}

// Function to add current view parameter to forms
function addViewParam(form) {
  const currentView = new URLSearchParams(window.location.search).get('view');
  if (currentView) {
    const currentAction = form.action;
    const separator = currentAction.includes('?') ? '&' : '?';
    form.action = currentAction + separator + 'view=' + currentView;
  }
}

// Edit Task Modal Functions
function editTaskModal(taskId) {
  // Get current view from URL
  const currentView = new URLSearchParams(window.location.search).get('view') || 'list';
  
  // Set form action with view parameter
  document.getElementById('editTaskForm').action = `/edit/${taskId}?view=${currentView}`;
  
  // Clear form
  document.getElementById('editTaskContent').value = '';
  document.getElementById('editTaskPriority').value = 'low';
  document.getElementById('editTaskDueDate').value = '';
  
  // Try to get current task data from the DOM
  const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
  if (taskElement) {
    // Get current content
    const contentElement = taskElement.querySelector('p');
    if (contentElement) {
      document.getElementById('editTaskContent').value = contentElement.textContent.trim();
    }
    
    // Try to determine priority from badge color
    const priorityBadge = taskElement.querySelector('.badge');
    if (priorityBadge) {
      if (priorityBadge.classList.contains('bg-danger') || priorityBadge.textContent.includes('')) {
        document.getElementById('editTaskPriority').value = 'high';
      } else if (priorityBadge.classList.contains('bg-warning') || priorityBadge.textContent.includes('Medium')) {
        document.getElementById('editTaskPriority').value = 'medium';
      } else {
        document.getElementById('editTaskPriority').value = 'low';
      }
    }
  }
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
  modal.show();
}

// Initialize Kanban board when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded');
  
  // Initialize theme
  initTheme();
  
  if (window.location.search.includes('view=kanban')) {
    console.log('Kanban view detected, initializing board...');
    
    // Add a small delay to ensure all elements are rendered
    setTimeout(() => {
      initKanbanBoard();
    }, 100);
  }
  
  // Initialize search and filter functionality
  initSearchAndFilter();
  
  // Highlight active view in navbar
  const currentView = new URLSearchParams(window.location.search).get('view') || 'list';
  const viewBtn = document.getElementById(currentView + '-view-btn');
  if (viewBtn) {
    viewBtn.classList.add('active');
  }
});

// Theme Management
function initTheme() {
  // Check for saved theme preference or default to 'light'
  const savedTheme = localStorage.getItem('taskflow-theme') || 'light';
  setTheme(savedTheme);
}

function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  setTheme(newTheme);
}

function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('taskflow-theme', theme);
  
  // Update both theme icons (in case both exist)
  const themeIcon = document.getElementById('themeIcon');
  const navThemeIcon = document.getElementById('navThemeIcon');
  
  if (themeIcon) {
    if (theme === 'dark') {
      themeIcon.className = 'bi bi-sun-fill';
    } else {
      themeIcon.className = 'bi bi-moon-fill';
    }
  }
  
  if (navThemeIcon) {
    if (theme === 'dark') {
      navThemeIcon.className = 'bi bi-sun-fill';
    } else {
      navThemeIcon.className = 'bi bi-moon-fill';
    }
  }
  
  // Update the theme toggle button title
  const themeToggle = document.getElementById('themeToggle');
  const navThemeToggle = document.getElementById('navThemeToggle');
  
  const titleText = theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
  
  if (themeToggle) {
    themeToggle.title = titleText;
  }
  
  if (navThemeToggle) {
    navThemeToggle.title = titleText;
  }
}

// Search and Filter Functionality
function initSearchAndFilter() {
  const searchInput = document.getElementById('searchInput');
  const priorityFilter = document.getElementById('priorityFilter');
  const statusFilter = document.getElementById('statusFilter');
  const dueDateFilter = document.getElementById('dueDateFilter');
  const clearFiltersBtn = document.getElementById('clearFilters');
  const clearSearchBtn = document.getElementById('clearSearch');
  
  // Real-time search
  if (searchInput) {
    searchInput.addEventListener('input', applyFilters);
    clearSearchBtn.addEventListener('click', function() {
      searchInput.value = '';
      applyFilters();
    });
  }
  
  // Filter dropdowns
  if (priorityFilter) priorityFilter.addEventListener('change', applyFilters);
  if (statusFilter) statusFilter.addEventListener('change', applyFilters);
  if (dueDateFilter) dueDateFilter.addEventListener('change', applyFilters);
  
  // Clear all filters
  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', function() {
      if (searchInput) searchInput.value = '';
      if (priorityFilter) priorityFilter.value = '';
      if (statusFilter) statusFilter.value = '';
      if (dueDateFilter) dueDateFilter.value = '';
      applyFilters();
    });
  }
}

function applyFilters() {
  const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
  const priorityFilter = document.getElementById('priorityFilter')?.value || '';
  const statusFilter = document.getElementById('statusFilter')?.value || '';
  const dueDateFilter = document.getElementById('dueDateFilter')?.value || '';
  
  const currentView = new URLSearchParams(window.location.search).get('view') || 'list';
  let taskElements;
  
  if (currentView === 'kanban') {
    taskElements = document.querySelectorAll('.kanban-task');
  } else {
    // For list view, get the column divs that contain the task cards
    taskElements = document.querySelectorAll('.task-card').length > 0 
      ? Array.from(document.querySelectorAll('.task-card')).map(card => card.closest('.col-md-6, .col-lg-4'))
      : document.querySelectorAll('[class*="col-md-6"], [class*="col-lg-4"]');
  }
  
  let visibleCount = 0;
  
  taskElements.forEach(taskElement => {
    const shouldShow = matchesFilters(taskElement, searchTerm, priorityFilter, statusFilter, dueDateFilter);
    
    if (shouldShow) {
      taskElement.classList.remove('task-hidden');
      visibleCount++;
    } else {
      taskElement.classList.add('task-hidden');
    }
  });
  
  // Update active filters display
  updateActiveFiltersDisplay(searchTerm, priorityFilter, statusFilter, dueDateFilter);
  
  // Update column counters for Kanban view
  if (currentView === 'kanban') {
    updateKanbanCounters();
  }
  
  // Show no results message if needed
  showNoResultsMessage(visibleCount === 0 && (searchTerm || priorityFilter || statusFilter || dueDateFilter));
}

function matchesFilters(taskElement, searchTerm, priorityFilter, statusFilter, dueDateFilter) {
  // Get task content
  const taskContent = taskElement.querySelector('p, .card-text')?.textContent.toLowerCase() || '';
  
  // Search term filter
  if (searchTerm && !taskContent.includes(searchTerm)) {
    return false;
  }
  
  // Priority filter
  if (priorityFilter) {
    const priorityBadge = taskElement.querySelector('.badge');
    if (!priorityBadge) return false;
    
    const hasPriority = 
      (priorityFilter === 'high' && (priorityBadge.classList.contains('bg-danger') || priorityBadge.textContent.includes('High'))) ||
      (priorityFilter === 'medium' && (priorityBadge.classList.contains('bg-warning') || priorityBadge.textContent.includes('Medium'))) ||
      (priorityFilter === 'low' && (priorityBadge.classList.contains('bg-success') || priorityBadge.textContent.includes('Low')));
    
    if (!hasPriority) return false;
  }
  
  // Status filter
  if (statusFilter) {
    const currentView = new URLSearchParams(window.location.search).get('view') || 'list';
    
    if (currentView === 'kanban') {
      const parentColumn = taskElement.closest('.kanban-tasks');
      if (!parentColumn) return false;
      
      const columnStatus = parentColumn.parentElement.dataset.status;
      if (columnStatus !== statusFilter) return false;
    } else {
      // For list view, check checkbox state
      const checkbox = taskElement.querySelector('input[type="checkbox"]');
      const isCompleted = checkbox?.checked || false;
      
      if (statusFilter === 'done' && !isCompleted) return false;
      if (statusFilter === 'todo' && isCompleted) return false;
      if (statusFilter === 'in_progress') {
        // For list view, we don't have in_progress state, so show nothing
        return false;
      }
    }
  }
  
  // Due date filter
  if (dueDateFilter) {
    const dueDateElement = taskElement.querySelector('.due-date-indicator');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (dueDateFilter === 'no_date' && dueDateElement) return false;
    if (dueDateFilter !== 'no_date' && !dueDateElement) return false;
    
    if (dueDateElement) {
      const dueDateText = dueDateElement.textContent.toLowerCase();
      
      switch (dueDateFilter) {
        case 'overdue':
          if (!dueDateText.includes('overdue')) return false;
          break;
        case 'today':
          if (!dueDateText.includes('due today')) return false;
          break;
        case 'tomorrow':
          if (!dueDateText.includes('due tomorrow')) return false;
          break;
        case 'this_week':
          if (!dueDateText.includes('due in') || dueDateText.includes('overdue')) return false;
          break;
      }
    }
  }
  
  return true;
}

function updateActiveFiltersDisplay(searchTerm, priorityFilter, statusFilter, dueDateFilter) {
  const activeFiltersDiv = document.getElementById('activeFilters');
  const filterTagsDiv = document.getElementById('filterTags');
  
  if (!activeFiltersDiv || !filterTagsDiv) return;
  
  let filterTags = '';
  
  if (searchTerm) {
    filterTags += `<span class="filter-tag">Search: "${searchTerm}" <button type="button" class="btn-close btn-close-white" onclick="clearSpecificFilter('search')"></button></span>`;
  }
  
  if (priorityFilter) {
    const priorityText = priorityFilter === 'high' ? 'High' : priorityFilter === 'medium' ? 'Medium' : 'Low';
    filterTags += `<span class="filter-tag">Priority: ${priorityText} <button type="button" class="btn-close btn-close-white" onclick="clearSpecificFilter('priority')"></button></span>`;
  }
  
  if (statusFilter) {
    const statusText = statusFilter === 'todo' ? ' To Do' : statusFilter === 'in_progress' ? ' In Progress' : ' Done';
    filterTags += `<span class="filter-tag">Status: ${statusText} <button type="button" class="btn-close btn-close-white" onclick="clearSpecificFilter('status')"></button></span>`;
  }
  
  if (dueDateFilter) {
    const dueDateText = {
      'overdue': ' Overdue',
      'today': ' Due Today', 
      'tomorrow': ' Due Tomorrow',
      'this_week': ' This Week',
      'no_date': ' No Due Date'
    }[dueDateFilter];
    filterTags += `<span class="filter-tag">Due: ${dueDateText} <button type="button" class="btn-close btn-close-white" onclick="clearSpecificFilter('dueDate')"></button></span>`;
  }
  
  if (filterTags) {
    filterTagsDiv.innerHTML = filterTags;
    activeFiltersDiv.classList.remove('d-none');
  } else {
    activeFiltersDiv.classList.add('d-none');
  }
}

function clearSpecificFilter(filterType) {
  switch (filterType) {
    case 'search':
      document.getElementById('searchInput').value = '';
      break;
    case 'priority':
      document.getElementById('priorityFilter').value = '';
      break;
    case 'status':
      document.getElementById('statusFilter').value = '';
      break;
    case 'dueDate':
      document.getElementById('dueDateFilter').value = '';
      break;
  }
  applyFilters();
}

function updateKanbanCounters() {
  const todoCount = document.querySelectorAll('#todo-tasks .kanban-task:not(.task-hidden)').length;
  const progressCount = document.querySelectorAll('#in_progress-tasks .kanban-task:not(.task-hidden)').length;
  const doneCount = document.querySelectorAll('#done-tasks .kanban-task:not(.task-hidden)').length;
  
  const todoBadge = document.querySelector('.kanban-todo .badge');
  const progressBadge = document.querySelector('.kanban-progress .badge');
  const doneBadge = document.querySelector('.kanban-done .badge');
  
  if (todoBadge) todoBadge.textContent = todoCount;
  if (progressBadge) progressBadge.textContent = progressCount;
  if (doneBadge) doneBadge.textContent = doneCount;
}

function showNoResultsMessage(show) {
  let noResultsDiv = document.getElementById('noResultsMessage');
  
  if (show && !noResultsDiv) {
    noResultsDiv = document.createElement('div');
    noResultsDiv.id = 'noResultsMessage';
    noResultsDiv.className = 'no-results';
    noResultsDiv.innerHTML = `
      <i class="bi bi-search" style="font-size: 3rem; color: #dee2e6;"></i>
      <h5 class="mt-3">No tasks found</h5>
      <p>Try adjusting your search terms or filters.</p>
    `;
    
    // Insert after the search section
    const searchSection = document.querySelector('.search-filter-section');
    if (searchSection) {
      searchSection.parentNode.insertBefore(noResultsDiv, searchSection.nextSibling);
    }
  } else if (!show && noResultsDiv) {
    noResultsDiv.remove();
  }
}
</script>
</body>
</html>
