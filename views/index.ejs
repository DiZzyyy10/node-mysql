<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .task-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .add-task-form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .task-completed {
      opacity: 0.6;
    }
    .task-completed .card-text {
      text-decoration: line-through;
      color: #6c757d;
    }
    .task-checkbox {
      transform: scale(1.2);
      margin-right: 10px;
    }
    .task-actions {
      opacity: 0;
      transition: opacity 0.2s;
    }
    .task-card:hover .task-actions {
      opacity: 1;
    }
    .edit-form {
      display: none;
    }
    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    .priority-indicator {
      width: 4px;
      height: 100%;
      position: absolute;
      left: 0;
      top: 0;
      border-radius: 8px 0 0 8px;
    }
    .priority-high { background-color: #dc3545; }
    .priority-medium { background-color: #ffc107; }
    .priority-low { background-color: #198754; }
    .priority-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    .task-card {
      position: relative;
    }
    .due-date-indicator {
      font-size: 0.75rem;
    }
    .due-today {
      color: #fd7e14;
      font-weight: bold;
    }
    .due-overdue {
      color: #dc3545;
      font-weight: bold;
    }
    .due-upcoming {
      color: #6f42c1;
    }
    
    /* Kanban Board Styles */
    .kanban-board {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding: 20px 0;
    }
    .kanban-column {
      flex: 1;
      min-width: 300px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
    }
    .kanban-header {
      text-align: center;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      font-weight: bold;
    }
    .kanban-todo { background-color: #e3f2fd; }
    .kanban-progress { background-color: #fff3e0; }
    .kanban-done { background-color: #e8f5e8; }
    
    .kanban-task {
      background: white;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: move;
      transition: all 0.2s;
    }
    .kanban-task:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .kanban-task.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    .kanban-tasks.drag-over {
      background-color: #e3f2fd;
      border: 2px dashed #2196f3;
      border-radius: 8px;
      min-height: 200px;
    }
    .kanban-tasks {
      min-height: 150px;
      padding: 10px;
    }
    .nav-link.active {
      background-color: rgba(255,255,255,0.2);
      border-radius: 4px;
    }
  </style>
</head>
<body>
<%- include('./header'); %>
<%- include('./error_messages'); %>
<% if(isAuth) { %>
<div class="container mt-4">
  <!-- Add Task Form -->
  <div class="add-task-form">
    <h4 class="mb-3">
      <i class="bi bi-plus-circle"></i> Add New Task
    </h4>
    <form action="/" method="post">
      <div class="row g-2">
        <div class="col-md-6">
          <input 
            required 
            type="text" 
            name="add" 
            class="form-control form-control-lg" 
            placeholder="What needs to be done?"
          />
        </div>
        <div class="col-md-2">
          <select name="priority" class="form-select form-select-lg">
            <option value="low">🟢 Low</option>
            <option value="medium" selected>🟡 Medium</option>
            <option value="high">🔴 High</option>
          </select>
        </div>
        <div class="col-md-2">
          <input 
            type="date" 
            name="due_date" 
            class="form-control form-control-lg"
            min="<%= new Date().toISOString().split('T')[0] %>"
          />
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-plus"></i> Add
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Tasks Display -->
  <% if (view === 'kanban') { %>
    <!-- Kanban Board View -->
    <div class="kanban-board">
      <!-- To Do Column -->
      <div class="kanban-column" data-status="todo">
        <div class="kanban-header kanban-todo">
          <i class="bi bi-list-task"></i> To Do
          <span class="badge bg-primary ms-2">
            <%= todos.filter(t => t.status === 'todo').length %>
          </span>
        </div>
        <div class="kanban-tasks" id="todo-tasks">
          <% todos.filter(t => t.status === 'todo').forEach(function(todo) { %>
            <%- include('partials/kanban-task', {todo: todo}) %>
          <% }) %>
        </div>
      </div>

      <!-- In Progress Column -->
      <div class="kanban-column" data-status="in_progress">
        <div class="kanban-header kanban-progress">
          <i class="bi bi-arrow-clockwise"></i> In Progress
          <span class="badge bg-warning ms-2">
            <%= todos.filter(t => t.status === 'in_progress').length %>
          </span>
        </div>
        <div class="kanban-tasks" id="in_progress-tasks">
          <% todos.filter(t => t.status === 'in_progress').forEach(function(todo) { %>
            <%- include('partials/kanban-task', {todo: todo}) %>
          <% }) %>
        </div>
      </div>

      <!-- Done Column -->
      <div class="kanban-column" data-status="done">
        <div class="kanban-header kanban-done">
          <i class="bi bi-check-circle"></i> Done
          <span class="badge bg-success ms-2">
            <%= todos.filter(t => t.status === 'done').length %>
          </span>
        </div>
        <div class="kanban-tasks" id="done-tasks">
          <% todos.filter(t => t.status === 'done').forEach(function(todo) { %>
            <%- include('partials/kanban-task', {todo: todo}) %>
          <% }) %>
        </div>
      </div>
    </div>
  <% } else { %>
    <!-- List View -->
    <div class="row">
      <div class="col-12">
        <h4 class="mb-3">
          <i class="bi bi-list-task"></i> Your Tasks
          <span class="badge bg-primary ms-2">
            <%= todos.filter(t => !t.completed).length %> active
          </span>
          <% if (todos.filter(t => t.completed).length > 0) { %>
            <span class="badge bg-success ms-1">
              <%= todos.filter(t => t.completed).length %> completed
            </span>
          <% } %>
        </h4>
        
        <% if(todos.length === 0) { %>
          <div class="text-center py-5">
            <i class="bi bi-clipboard-check" style="font-size: 4rem; color: #dee2e6;"></i>
            <p class="text-muted mt-3">No tasks yet! Add your first task above.</p>
          </div>
        <% } else { %>
          <div class="row">
            <% for(let todo of todos){ %>
              <%- include('partials/list-task', {todo: todo}) %>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  <% } %>
</div>
<% } else { %>
  <div class="container text-center mt-5">
    <h1 class="display-4 mb-4">Welcome to TaskFlow</h1>
    <p class="lead mb-4">Your personal productivity companion</p>
    <a class="btn btn-primary btn-lg" href="/signup" role="button">
      <i class="bi bi-person-plus"></i> Get Started
    </a>
  </div>
<% } %>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editTaskForm" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label for="editTaskContent" class="form-label">Task Description</label>
            <input type="text" class="form-control" id="editTaskContent" name="content" required>
          </div>
          <div class="mb-3">
            <label for="editTaskPriority" class="form-label">Priority</label>
            <select class="form-select" id="editTaskPriority" name="priority" required>
              <option value="low">🟢 Low</option>
              <option value="medium">🟡 Medium</option>
              <option value="high">🔴 High</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editTaskDueDate" class="form-label">Due Date</label>
            <input type="date" class="form-control" id="editTaskDueDate" name="due_date">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function editTask(taskId) {
  // Hide display mode
  document.querySelector('.task-display-' + taskId).style.display = 'none';
  // Show edit mode
  document.querySelector('.task-edit-' + taskId).style.display = 'block';
  // Focus on the input
  document.querySelector('.task-edit-' + taskId + ' input').focus();
}

function cancelEdit(taskId) {
  // Show display mode
  document.querySelector('.task-display-' + taskId).style.display = 'block';
  // Hide edit mode
  document.querySelector('.task-edit-' + taskId).style.display = 'none';
}

function formatDueDate(dueDate) {
  if (!dueDate) return '';
  
  const today = new Date();
  const due = new Date(dueDate);
  const diffTime = due.getTime() - today.getTime();
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) {
    return { text: `Overdue by ${Math.abs(diffDays)} day(s)`, class: 'due-overdue' };
  } else if (diffDays === 0) {
    return { text: 'Due today', class: 'due-today' };
  } else if (diffDays === 1) {
    return { text: 'Due tomorrow', class: 'due-upcoming' };
  } else if (diffDays <= 7) {
    return { text: `Due in ${diffDays} days`, class: 'due-upcoming' };
  } else {
    return { text: `Due ${due.toLocaleDateString()}`, class: '' };
  }
}

// Kanban Board Functionality
function initKanbanBoard() {
  console.log('Initializing Kanban board...');
  const kanbanTasks = document.querySelectorAll('.kanban-task');
  const kanbanColumns = document.querySelectorAll('.kanban-tasks');
  
  console.log('Found tasks:', kanbanTasks.length);
  console.log('Found columns:', kanbanColumns.length);
  
  // Test if tasks are properly found
  kanbanTasks.forEach((task, index) => {
    console.log(`Task ${index}:`, task.dataset.taskId, 'draggable:', task.draggable);
  });
  
  // Add drag events to tasks
  kanbanTasks.forEach((task, index) => {
    console.log(`Adding drag events to task ${index}:`, task.dataset.taskId);
    
    // Ensure draggable is set
    task.draggable = true;
    
    task.addEventListener('dragstart', handleDragStart);
    task.addEventListener('dragend', handleDragEnd);
    
    // Add test click event to verify event handling works
    task.addEventListener('click', function(e) {
      if (!e.target.closest('button')) {
        console.log('Task clicked:', this.dataset.taskId);
      }
    });
  });
  
  // Add drop events to columns
  kanbanColumns.forEach((column, index) => {
    console.log(`Adding drop events to column ${index}:`, column.id);
    column.addEventListener('dragover', handleDragOver);
    column.addEventListener('drop', handleDrop);
    column.addEventListener('dragenter', handleDragEnter);
    column.addEventListener('dragleave', handleDragLeave);
  });
  
  // Also add events to the column containers for better drop zone coverage
  const columnContainers = document.querySelectorAll('.kanban-column');
  columnContainers.forEach((container, index) => {
    console.log(`Adding additional drop events to container ${index}:`, container.dataset.status);
    container.addEventListener('dragover', handleDragOver);
    container.addEventListener('dragenter', function(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      const tasksArea = this.querySelector('.kanban-tasks');
      if (tasksArea) {
        console.log('Container drag enter:', tasksArea.id);
        tasksArea.classList.add('drag-over');
      }
    });
    container.addEventListener('drop', function(e) {
      const tasksArea = this.querySelector('.kanban-tasks');
      if (tasksArea) {
        handleDrop.call(tasksArea, e);
      }
    });
  });
}

let draggedTask = null;

function handleDragStart(e) {
  console.log('Drag start:', this.dataset.taskId);
  draggedTask = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.outerHTML);
}

function handleDragEnd(e) {
  console.log('Drag end');
  this.classList.remove('dragging');
  // Don't reset draggedTask here - we need it in handleDrop
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDragEnter(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  console.log('Drag enter:', this.id);
  this.classList.add('drag-over');
  return false;
}

function handleDragLeave(e) {
  // Only remove drag-over if we're actually leaving this element
  if (!this.contains(e.relatedTarget)) {
    console.log('Drag leave:', this.id);
    this.classList.remove('drag-over');
  }
}

function handleDrop(e) {
  console.log('Drop event triggered on:', this.id);
  
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  if (e.preventDefault) {
    e.preventDefault();
  }
  
  this.classList.remove('drag-over');
  
  if (!draggedTask) {
    console.log('No dragged task found');
    return false;
  }
  
  const taskId = draggedTask.dataset.taskId;
  const newStatus = this.parentElement.dataset.status;
  const currentColumn = draggedTask.closest('.kanban-tasks');
  const oldStatus = currentColumn ? currentColumn.parentElement.dataset.status : null;
  
  console.log('Drop details:', { taskId, newStatus, oldStatus });
  
  if (newStatus !== oldStatus) {
    // Cross-column move (status change)
    console.log('Status changed, moving task...');
    this.appendChild(draggedTask);
    updateTaskStatus(taskId, newStatus);
  } else {
    // Intra-column reorder (same status, different position)
    console.log('Reordering within same column...');
    
    // Calculate new position based on drop location
    const dropY = e.clientY;
    const tasks = Array.from(this.children);
    let newPosition = tasks.length;
    
    // Find where to insert based on mouse position
    for (let i = 0; i < tasks.length; i++) {
      const task = tasks[i];
      if (task === draggedTask) continue;
      
      const rect = task.getBoundingClientRect();
      const taskMiddle = rect.top + rect.height / 2;
      
      if (dropY < taskMiddle) {
        newPosition = i;
        break;
      }
    }
    
    // Get current position of dragged task
    const currentPosition = tasks.indexOf(draggedTask);
    
    // Only reorder if position actually changed
    if (newPosition !== currentPosition && newPosition !== currentPosition + 1) {
      // Adjust position if moving down (account for removed element)
      if (newPosition > currentPosition) {
        newPosition--;
      }
      
      console.log('Reordering from position', currentPosition, 'to', newPosition);
      
      // Move the element visually
      if (newPosition >= tasks.length - 1) {
        this.appendChild(draggedTask);
      } else {
        this.insertBefore(draggedTask, this.children[newPosition]);
      }
      
      // Update on server
      updateTaskOrder(taskId, newPosition, newStatus);
    } else {
      console.log('Position unchanged, no reorder needed');
    }
  }
  
  // Reset dragged task
  draggedTask = null;
  
  return false;
}

function updateTaskStatus(taskId, newStatus) {
  console.log('Updating task status:', { taskId, newStatus });
  
  fetch(`/status/${taskId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({ status: newStatus }),
  })
  .then(response => {
    console.log('Response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Task status updated successfully:', data);
    // Update column counters
    updateColumnCounters();
  })
  .catch(error => {
    console.error('Error updating task status:', error);
    alert('Failed to update task status. Please try again.');
    // Reload page on error to ensure consistency
    window.location.reload();
  });
}

function updateTaskOrder(taskId, newPosition, status) {
  console.log('Updating task order:', { taskId, newPosition, status });
  
  fetch('/reorder', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    },
    body: JSON.stringify({ 
      taskId: taskId, 
      newPosition: newPosition, 
      status: status 
    }),
  })
  .then(response => {
    console.log('Reorder response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Task order updated successfully:', data);
  })
  .catch(error => {
    console.error('Error updating task order:', error);
    alert('Failed to reorder task. Please try again.');
    // Reload page on error to ensure consistency
    window.location.reload();
  });
}

function updateColumnCounters() {
  const todoCount = document.querySelectorAll('#todo-tasks .kanban-task').length;
  const progressCount = document.querySelectorAll('#in_progress-tasks .kanban-task').length;
  const doneCount = document.querySelectorAll('#done-tasks .kanban-task').length;
  
  document.querySelector('.kanban-todo .badge').textContent = todoCount;
  document.querySelector('.kanban-progress .badge').textContent = progressCount;
  document.querySelector('.kanban-done .badge').textContent = doneCount;
}

function deleteTask(taskId) {
  if (confirm('Are you sure you want to delete this task?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/delete/${taskId}`;
    document.body.appendChild(form);
    form.submit();
  }
}

// Function to add current view parameter to forms
function addViewParam(form) {
  const currentView = new URLSearchParams(window.location.search).get('view');
  if (currentView) {
    const currentAction = form.action;
    const separator = currentAction.includes('?') ? '&' : '?';
    form.action = currentAction + separator + 'view=' + currentView;
  }
}

// Edit Task Modal Functions
function editTaskModal(taskId) {
  // Get current view from URL
  const currentView = new URLSearchParams(window.location.search).get('view') || 'list';
  
  // Set form action with view parameter
  document.getElementById('editTaskForm').action = `/edit/${taskId}?view=${currentView}`;
  
  // Clear form
  document.getElementById('editTaskContent').value = '';
  document.getElementById('editTaskPriority').value = 'low';
  document.getElementById('editTaskDueDate').value = '';
  
  // Try to get current task data from the DOM
  const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
  if (taskElement) {
    // Get current content
    const contentElement = taskElement.querySelector('p');
    if (contentElement) {
      document.getElementById('editTaskContent').value = contentElement.textContent.trim();
    }
    
    // Try to determine priority from badge color
    const priorityBadge = taskElement.querySelector('.badge');
    if (priorityBadge) {
      if (priorityBadge.classList.contains('bg-danger') || priorityBadge.textContent.includes('�')) {
        document.getElementById('editTaskPriority').value = 'high';
      } else if (priorityBadge.classList.contains('bg-warning') || priorityBadge.textContent.includes('🟡')) {
        document.getElementById('editTaskPriority').value = 'medium';
      } else {
        document.getElementById('editTaskPriority').value = 'low';
      }
    }
  }
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
  modal.show();
}

// Initialize Kanban board when page loads
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded');
  if (window.location.search.includes('view=kanban')) {
    console.log('Kanban view detected, initializing board...');
    
    // Add a small delay to ensure all elements are rendered
    setTimeout(() => {
      initKanbanBoard();
    }, 100);
  }
  
  // Highlight active view in navbar
  const currentView = new URLSearchParams(window.location.search).get('view') || 'list';
  const viewBtn = document.getElementById(currentView + '-view-btn');
  if (viewBtn) {
    viewBtn.classList.add('active');
  }
});
</script>
</body>
</html>
